//=============================================================================
// LN_AdvancedMapPuzzleSystem.js
// ----------------------------------------------------------------------------
// Copyright (c) 2020 lriki
// This software is released under the MIT License.
// http://opensource.org/licenses/mit-license.php
// ----------------------------------------------------------------------------
// [GitHub] : https://github.com/lriki/LN_AdvancedMapPuzzleSystem
// [Twitter]: https://twitter.com/lriki8
//=============================================================================

/*:ja
 * @plugindesc 謎解きマップシステムプラグイン v0.1.0
 * @author lriki
 * 
 * @param GuideLineTerrainTag
 * @desc 箱オブジェクトの移動ガイドラインとなる地形タグです。
 * @default 7
 * @type number
 *
 * @help マップ上のキャラクター移動やイベントシステムを拡張し、
 * 謎解きの幅を広げるための様々な機能を追加します。
 * 
 * MIT License
 */


!function(r){var n={};function i(t){if(n[t])return n[t].exports;var e=n[t]={i:t,l:!1,exports:{}};return r[t].call(e.exports,e,e.exports,i),e.l=!0,e.exports}i.m=r,i.c=n,i.d=function(t,e,r){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(r,n,function(t){return e[t]}.bind(null,n));return r},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=3)}([function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.paramGuideLineTerrainTag=Number(PluginManager.parameters("LN_AdvancedMapPuzzleSystem").GuideLineTerrainTag)},function(t,e,r){"use strict";var n,i,o,a;Object.defineProperty(e,"__esModule",{value:!0}),e.assert=function(t,e){if(!t)throw new Error(e)},(i=n=e.ObjectType||(e.ObjectType={}))[i.Character=0]="Character",i[i.Box=1]="Box",(a=o=e.EventTrigger||(e.EventTrigger={}))[a.None=0]="None",a[a.OnCharacterRideOn=1]="OnCharacterRideOn",a[a.OnStartedFalling=2]="OnStartedFalling",e.strToObjectType=function(t){return"box"===t.toLocaleLowerCase()?n.Box:n.Character},e.strToEventTrigger=function(t){var e=t.toLocaleLowerCase();return"oncharacterrideon"===e?o.OnCharacterRideOn:"onstartedfalling"===e?o.OnStartedFalling:o.None}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n={name:"Evasion1",volume:80,pitch:110,pan:0},i={name:"Earth3",volume:80,pitch:100,pan:0},o=SoundManager.preloadImportantSounds;SoundManager.preloadImportantSounds=function(){o.call(SoundManager),$dataSystem&&AudioManager.loadStaticSe(n)};var a=(s.playGSJump=function(){$dataSystem&&AudioManager.playStaticSe(n)},s.playGSFalled=function(){AudioManager.playSe(i)},s);function s(){}e.AMPS_SoundManager=a},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),r(0),r(2),r(4),r(6),r(7),r(8)},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a,n,i=r(1),s=r(5),u=r(2);(n=a=a||{})[n.GroundToGround=0]="GroundToGround",n[n.GroundToObject=1]="GroundToObject",n[n.ObjectToObject=2]="ObjectToObject",n[n.ObjectToGround=3]="ObjectToGround";var o=Game_CharacterBase.prototype.initMembers;Game_CharacterBase.prototype.initMembers=function(){o.call(this),this.objectType=i.ObjectType.Character,this._ridingCharacterId=-1,this._ridderCharacterId=-1,this._waitAfterJump=0,this._extraJumping=!1,this._ridingScreenZPriority=-1,this._movingMode=a.GroundToGround,this._forcePositionAdjustment=!1,this._getonoffFrameCount=0,this._getonoffFrameMax=0,this._getonoffStartX=0,this._getonoffStartY=0};var c=Game_CharacterBase.prototype.moveStraight;Game_CharacterBase.prototype.moveStraight=function(t){i.assert(2==t||4==t||6==t||8==t),this.moveStraightMain(t)};var h=Game_CharacterBase.prototype.moveDiagonally;Game_CharacterBase.prototype.moveDiagonally=function(t,e){h.call(this,t,e)},Game_CharacterBase.prototype.ridding=function(){return!1},Game_CharacterBase.prototype.falling=function(){return!1},Game_CharacterBase.prototype.isMapObject=function(){return!1},Game_CharacterBase.prototype.objectId=function(){return-1},Game_CharacterBase.prototype.objectHeight=function(){return-1},Game_CharacterBase.prototype.canRide=function(){return 0<=this.objectHeight()},Game_CharacterBase.prototype.checkPassRide=function(t,e){if(this.canRide()&&!this.rider()){var r=Math.round(this._x),n=Math.round(this._y)-this.objectHeight();if(t==r&&e==n)return!0}return!1},Game_CharacterBase.prototype.rider=function(){return this._ridderCharacterId<0?void 0:0==this._ridderCharacterId?$gamePlayer:$gameMap.event(this._ridderCharacterId)},Game_CharacterBase.prototype.riddingObject=function(){return this._ridingCharacterId<0?void 0:0==this._ridingCharacterId?$gamePlayer:$gameMap.event(this._ridingCharacterId)};var d=Game_CharacterBase.prototype.screenZ;Game_CharacterBase.prototype.screenZ=function(){var t=d.call(this),e=this.riddingObject();return this.ridding()&&e&&(t+=e.screenZ()),0<=this._ridingScreenZPriority&&(t=this._ridingScreenZPriority),t+(this._extraJumping?6:0)},Game_CharacterBase.prototype.moveStraightMain=function(t){0<this._waitAfterJump?this._waitAfterJump--:(this.setMovementSuccess(!1),this.ridding()||this.attemptMoveGroundToGround(t)||this.attemptJumpGroundToGround(t)||this.attemptJumpGroove(t)||this.attemptMoveGroundToObject(t,!1))},Game_CharacterBase.prototype.attemptMoveGroundToGround=function(t){var e=this._x,r=this._y;return c.call(this,t),!!this._movementSuccess&&(this._forcePositionAdjustment&&(this._x=Math.round(s.MovingHelper.roundXWithDirection(e,t)),this._y=Math.round(s.MovingHelper.roundYWithDirection(r,t))),this._movingMode=a.GroundToGround,!0)},Game_CharacterBase.prototype.attemptJumpGroundToGround=function(t){return!!s.MovingHelper.canPassJumpGroundToGround(this,this._x,this._y,t)&&(this.setMovementSuccess(!0),this.jumpToDir(t,2,!1),this._movingMode=a.GroundToGround,!0)},Game_CharacterBase.prototype.attemptJumpGroove=function(t){return!!s.MovingHelper.canPassJumpGroove(this,this._x,this._y,t)&&(this.setMovementSuccess(!0),this.jumpToDir(t,2,!1),this._movingMode=a.GroundToGround,!0)},Game_CharacterBase.prototype.attemptMoveGroundToObject=function(t,e){var r=s.MovingHelper.checkMoveOrJumpGroundToObject(this._x,this._y,t,1,e);return!!r&&(this.setMovementSuccess(!0),this.resetGetOnOffParams(),this.moveToDir(t,!0),this.rideToObject(r),this._movingMode=a.GroundToObject,!0)},Game_CharacterBase.prototype.rideToObject=function(t){i.assert(0<=this.objectId()),i.assert(0<=t.objectId()),this._ridingCharacterId=t.objectId(),t._ridderCharacterId=this.objectId();var e=this._ridingScreenZPriority;this._ridingScreenZPriority=-1,this._ridingScreenZPriority=this.screenZ(),this._ridingScreenZPriority=Math.max(this._ridingScreenZPriority,e)},Game_CharacterBase.prototype.moveToDir=function(t,e){this._x=$gameMap.roundXWithDirection(this._x,t),this._y=$gameMap.roundYWithDirection(this._y,t),this._realX=$gameMap.xWithDirection(this._x,this.reverseDir(t)),this._realY=$gameMap.yWithDirection(this._y,this.reverseDir(t)),(e||this._forcePositionAdjustment)&&(this._y=Math.round(this._y)),this._forcePositionAdjustment&&(this._x=Math.round(this._x))},Game_CharacterBase.prototype.jumpToDir=function(t,e,r){var n=this._x,i=this._y;r||(n=Math.round(this._x),2==t||8==t||(i=Math.round(this._y)));var o=Math.round(s.MovingHelper.roundXWithDirectionLong(this._x,t,e)),a=Math.round(s.MovingHelper.roundYWithDirectionLong(this._y,t,e));this.jump(o-n,a-i),this._waitAfterJump=10,this._extraJumping=!0,u.AMPS_SoundManager.playGSJump()};var p=Game_CharacterBase.prototype.updateJump;Game_CharacterBase.prototype.updateJump=function(){var t,e,r,n,i,o=this.isJumping();p.call(this),this.ridding()&&o&&(this._movingMode!=a.GroundToObject&&this._movingMode!=a.ObjectToObject||(t=this.riddingObject())&&(e=t._realX,r=t._realY-t.objectHeight(),n=2*this._jumpPeak,i=Math.min((n-this._jumpCount+1)/n,1),this._realX=s.MovingHelper.linear(i,this._getonoffStartX,e-this._getonoffStartX,1),this._realY=s.MovingHelper.linear(i,this._getonoffStartY,r-this._getonoffStartY,1),this._x=t._x,this._y=t._y-t.objectHeight())),this.isJumping()||(this._extraJumping=!1,o!=this.isJumping()&&this.onJumpEnd())},Game_CharacterBase.prototype.resetGetOnOffParams=function(){this._getonoffFrameMax=1/this.distancePerFrame(),this._getonoffFrameCount=0,this._getonoffStartX=this._realX,this._getonoffStartY=this._realY},Game_CharacterBase.prototype.onJumpEnd=function(){var t=this.riddingObject();t&&t.onCharacterRideOn()},Game_CharacterBase.prototype.onCharacterRideOn=function(){}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var u=r(1),c=r(0),n=(f.isHalfStepX=function(t){return Math.floor(t.x)!==t.x},f.isHalfStepY=function(t){return Math.floor(t.y)!==t.y},f.roundXWithDirection=function(t,e){return $gameMap.roundX(t+(6===e?1:4===e?-1:0))},f.roundYWithDirection=function(t,e){return $gameMap.roundY(t+(2===e?1:8===e?-1:0))},f.roundXWithDirectionLong=function(t,e,r){for(var n=f.roundXWithDirection(t,e),i=Math.floor(r),o=0;o<i-1;o++)n=f.roundXWithDirection(n,e);var a=r-Math.floor(r);return 0<a&&(n+=f.roundXWithDirection(0,e)*a),n},f.roundYWithDirectionLong=function(t,e,r){for(var n=f.roundYWithDirection(t,e),i=Math.floor(r),o=0;o<i-1;o++)n=f.roundYWithDirection(n,e);var a=r-Math.floor(r);return 0<a&&(n+=f.roundYWithDirection(0,e)*a),n},f.checkFacingOutsideOnEdgeTile=function(t,e,r){var n=Math.round(t),i=Math.round(e);return!$gameMap.isPassable(n,i,r)},f.checkFacingOtherEdgeTile=function(t,e,r,n){var i=Math.round(f.roundXWithDirectionLong(t,r,n)),o=Math.round(f.roundYWithDirectionLong(e,r,n));return!$gameMap.isPassable(i,o,f.reverseDir(r))},f.canPassJumpGroove=function(t,e,r,n){if(2!=n&&8!=n||!f.isHalfStepX(t))return f.canPassJumpGrooveInternal(t,e,r,n);var i=f.canPassJumpGrooveInternal(t,e-1,r,n),o=f.canPassJumpGrooveInternal(t,e,r,n);return!(!i||!o)&&o},f.canPassJumpGrooveInternal=function(t,e,r,n){var i=Math.round(e),o=Math.round(r),a=Math.round(f.roundXWithDirectionLong(e,n,2)),s=Math.round(f.roundYWithDirectionLong(r,n,2)),u=Math.round(f.roundXWithDirectionLong(e,n,1)),c=Math.round(f.roundYWithDirectionLong(r,n,1)),h=f.roundXWithDirectionLong(e,n,2),d=f.roundYWithDirectionLong(r,n,2);if(!$gameMap.isValid(a,s))return!1;if(!$gameMap.isPassable(i,o,n))return!1;var p=t.reverseDir(n);return!!$gameMap.isPassable(a,s,p)&&!t.isCollidedWithCharacters(h,d)&&!!$gameMap.checkGroove(u,c)},f.checkJumpGroundToGroundInternal=function(t,e,r,n,i){var o=Math.round(e),a=Math.round(r),s=f.roundXWithDirectionLong(e,n,i),u=f.roundYWithDirectionLong(r,n,i),c=Math.round(s),h=Math.round(u);if(!$gameMap.isValid(c,h))return{pass:!1,x:0,y:0};var d=t.reverseDir(n);if($gameMap.isPassable(o,a,n)||$gameMap.isPassable(c,h,d))return{pass:!1,x:0,y:0};if($gameMap.checkNotPassageAll(c,h))return{pass:!1,x:0,y:0};if(t.isCollidedWithCharacters(s,u))return{pass:!1,x:0,y:0};var p=f.roundXWithDirectionLong(e,n,1),l=f.roundYWithDirectionLong(r,n,1);return f.isCollidedWithRiddingEvents(p,l)?{pass:!1,x:0,y:0}:{pass:!0,x:s,y:u}},f.checkMoveOrJumpGroundToObject=function(t,e,r,n,i){var o=Math.round(t),a=Math.round(e),s=Math.round(f.roundXWithDirectionLong(t,r,n)),u=Math.round(f.roundYWithDirectionLong(e,r,n));if(i||!$gameMap.isPassable(o,a,r)){var c=f.findPassableRideObject(s,u);return c||void 0}},f.checkMoveOrJumpObjectToGround=function(t,e,r,n,i){var o=Math.round(f.roundXWithDirectionLong(e,n,i)),a=Math.round(f.roundYWithDirectionLong(r,n,i));if(t.objectType==u.ObjectType.Box&&!t.falling()&&$gameMap.terrainTag(o,a)!=c.paramGuideLineTerrainTag)return!1;var s=t.reverseDir(n);return!$gameMap.isPassable(o,a,s)&&!$gameMap.checkNotPassageAll(o,a)&&!t.isCollidedWithCharacters(o,a)},f.checkMoveOrJumpObjectToObject=function(t,e,r,n){var i=Math.round(f.roundXWithDirectionLong(t,r,n)),o=Math.round(f.roundYWithDirectionLong(e,r,n)),a=f.findPassableRideObject(i,o);if(a)return a},f.isCollidedWithRiddingEvents=function(t,e){return $gameMap.eventsXyNt(t,e).some(function(t){return t.ridding()})},f.findPassableRideObject=function(t,e){for(var r=$gameMap.events(),n=0;n<r.length;n++)if(r[n].checkPassRide(t,e))return r[n]},f.findCharacterById=function(t){return 0==t?$gamePlayer:$gameMap.events()[t-1]},f.canPassJumpGroundToGround=function(t,e,r,n){if(Math.round(e),Math.round(r),Math.round(f.roundXWithDirectionLong(e,n,2)),Math.round(f.roundYWithDirectionLong(r,n,2)),2==n||8==n){var i=2-(r-Math.floor(r));if(f.isHalfStepX(t)){var o=f.checkJumpGroundToGroundInternal(t,e-1,r,n,i),a=f.checkJumpGroundToGroundInternal(t,e,r,n,i);return!(!o.pass||!a.pass)&&a.pass}return f.checkJumpGroundToGroundInternal(t,e,r,n,i).pass}if(!f.isHalfStepY(t)||4!=n&&6!=n)return f.checkJumpGroundToGroundInternal(t,e,r,n,2).pass;if(!(o=f.checkJumpGroundToGroundInternal(t,e,r,n,2)).pass)return!1;var s=o.x,u=Math.ceil(o.y);return!(t.isCollidedWithCharacters(s,u)&&!(a=f.checkJumpGroundToGroundInternal(t,Math.round(e),u-1,n,2)).pass)&&o.pass},f.findObject=function(t,e){for(var r=$gameMap.eventsXyNt(t,e),n=0;n<r.length;n++)if(r[n].isMapObject())return r[n]},f.reverseDir=function(t){return 10-t},f.linear=function(t,e,r,n){return r*(t/n)+e},f.easeInExpo=function(t,e,r,n){return r*Math.pow(2,10*(t/n-1))+e},f.distance2D=function(t,e,r,n){var i=r-t,o=n-e;return Math.sqrt(i*i+o*o)},f);function f(){}e.MovingHelper=n},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),Game_Player.prototype.objectId=function(){return 0}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s=r(1),n=Game_Event.prototype.initMembers;Game_Event.prototype.initMembers=function(){n.call(this),this._objectType=s.ObjectType.Character,this._objectHeight=-1,this._fallable=!1,this._eventTrigger=s.EventTrigger.None},Game_Event.prototype.isMapObject=function(){return this._objectType!=s.ObjectType.Character},Game_Event.prototype.objectId=function(){return this.eventId()},Game_Event.prototype.objectHeight=function(){return this._objectHeight};var i=Game_Event.prototype.setupPage;Game_Event.prototype.setupPage=function(){var t=this.objectHeight(),e=this.rider();i.call(this),this.parseListCommentForAMPSObject(),0==this.objectHeight()&&e&&e.jump(0,t)},Game_Event.prototype.parseListCommentForAMPSObject=function(){this._objectType=s.ObjectType.Character,this._objectHeight=-1,this._fallable=!1,this._eventTrigger=s.EventTrigger.None;var t=this.list().parameters;if(t&&1<t.length){for(var e="",r=0;r<t.length;r++)108!=t[r].code&&408!=t[r].code||(e+=t[r].parameters[0]);var n=e.indexOf("@MapObject");if(0<=n){for(var i=e.substring(n+6),o=(i=i.substring(i.indexOf("{")+1,i.indexOf("}"))).split(","),r=0;r<o.length;r++){var a=o[r].split(":");switch(a[0].trim()){case"type":this._objectType=s.strToObjectType(a[1].trim());break;case"h":case"height":this._objectHeight=Number(a[1].trim());break;case"fallable":this._fallable="true"==a[1].trim();break;case"trigger":this._eventTrigger=s.strToEventTrigger(a[1].trim())}}return!0}}return!1}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s=r(0);Game_Map.prototype.checkPassage=function(t,e,r){for(var n=this.tilesetFlags(),i=this.allTiles(t,e),o=0;o<i.length;o++){var a=n[i[o]];if(n[i[o]]>>12!=s.paramGuideLineTerrainTag&&0==(16&a)){if(0==(a&r))return!0;if((a&r)===r)return!1}}return!1},Game_Map.prototype.checkNotPassageAll=function(t,e){for(var r=this.tilesetFlags(),n=this.allTiles(t,e),i=0,o=0;o<n.length;o++){i|=r[n[o]]}return 15==(15&i)},Game_Map.prototype.checkGroove=function(t,e){for(var r=this.allTiles(t,e),n=0;n<r.length;n++)if(Tilemap.isTileA1(r[n]))return!0;return!1}}]);