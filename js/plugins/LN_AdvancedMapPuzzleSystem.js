//=============================================================================
// LN_AdvancedMapPuzzleSystem.js
// ----------------------------------------------------------------------------
// Copyright (c) 2020 lriki
// This software is released under the MIT License.
// http://opensource.org/licenses/mit-license.php
// ----------------------------------------------------------------------------
// [GitHub] : https://github.com/lriki/LN_AdvancedMapPuzzleSystem
// [Twitter]: https://twitter.com/lriki8
//=============================================================================

/*:ja
 * @plugindesc 謎解きマップシステムプラグイン v0.4.4
 * @author lriki
 *
 * @help マップ上のキャラクター移動やイベントシステムを拡張し、謎解きの幅を広げるための様々な機能を追加します。
 *
 * # 他プラグインとの競合情報
 * - triacontane 様の HalfMove.js と併用する場合は、本プラグインをリストの下に追加してください。
 * - サンシロ 様の SAN_AnalogMove.js と併用する場合は、本プラグインをリストの下に追加してください。
 *
 * @param MapSkillEffectsMapId
 * @desc TODO
 * @type number
 * @default 1
 * 
 * @param GuideLineTerrainTag
 * @desc 箱オブジェクトの移動ガイドラインとなる地形タグです。
 * @type number
 * @default 7
 * 
 * @param AllowAllMapPuzzles
 * @desc エリアタイプのすべてのマップで、謎解きシステムを有効にするかどうかを設定します。 false にした場合、規定ではすべてのマップで無効となり、マップのメモ欄に <LNPuzzleEnable> と記入したマップだけ有効になります。
 * @default true
 * @type boolean
 * 
 * MIT License
 */


!function(i){var r={};function n(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return i[e].call(t.exports,t,t.exports,n),t.l=!0,t.exports}n.m=i,n.c=r,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)n.d(i,r,function(e){return t[e]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=6)}([function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r="LN_AdvancedMapPuzzleSystem";t.paramMapSkillEffectsMapId=Number(PluginManager.parameters(r).MapSkillEffectsMapId),t.paramGuideLineTerrainTag=Number(PluginManager.parameters(r).GuideLineTerrainTag),t.paramFallingSpeed=5,t.paramAllowAllMapPuzzles=!0;var n=PluginManager.parameters(r).AllowAllMapPuzzles;null!=n&&(t.paramAllowAllMapPuzzles="true"===n.toLowerCase()),t.paramSlipRegion=1,t.paramSlippingAnimationPattern=2},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=i(0),a=DataManager.onLoad;DataManager.onLoad=function(e){if(a.call(this,e),0<n.paramMapSkillEffectsMapId&&e===$dataMapSkillEffectsMap){this.extractMetadata(e);for(var t=e.events,i=0;i<t.length;i++){var r=t[i];r&&void 0!==r.note&&this.extractMetadata(r)}}};var r=(o.dataMapSkillEffectsMap=function(){return $dataMapSkillEffectsMap},o.padZero=function(e,t){for(var i=e;i.length<t;)i="0"+i;return i},o.init=function(){0<n.paramMapSkillEffectsMapId&&DataManager.loadDataFile("$dataMapSkillEffectsMap","Map001.json")},o.tempMapSkillEffectDataId=-1,o.tempMapSkillEffectInvokerId=-1,o.pluginCommand=function(e,t){switch(e){case"AMPS-MapSkill":switch(t[0]){case"call":$gameMap.spawnMapSkillEffectEvent(t[1])}}},o);function o(){}t.AMPSManager=r},function(e,t,i){"use strict";var r,n,a;Object.defineProperty(t,"__esModule",{value:!0}),t.assert=function(e,t){if(!e)throw new Error(t)},(n=r=t.EventTrigger||(t.EventTrigger={}))[n.None=0]="None",n[n.OnRideOnEvent=1]="OnRideOnEvent",n[n.OnStartFalling=2]="OnStartFalling",n[n.OnSpawnedAsEffect=3]="OnSpawnedAsEffect",n[n.OnCollidedAsEffect=4]="OnCollidedAsEffect",t.strToEventTrigger=function(e){var t=e.toLocaleLowerCase();return"onrideonevent"===t?r.OnRideOnEvent:"onstartfalling"===t?r.OnStartFalling:"onspawnedaseffect"===t?r.OnSpawnedAsEffect:"oncollidedaseffect"===t?r.OnCollidedAsEffect:r.None},(a=t.MovingMode||(t.MovingMode={}))[a.Stopping=0]="Stopping",a[a.GroundToGround=1]="GroundToGround",a[a.GroundToObject=2]="GroundToObject",a[a.ObjectToObject=3]="ObjectToObject",a[a.ObjectToGround=4]="ObjectToGround"},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var c=i(0),r=(g.isHalfStepX=function(e){return Math.floor(e.x)!==e.x},g.isHalfStepY=function(e){return Math.floor(e.y)!==e.y},g.frontX=function(e,t){return e+(6===t?1:4===t?-1:0)},g.frontY=function(e,t){return e+(2===t?1:8===t?-1:0)},g.frontXAligned=function(e,t){return Math.round(e)+(6===t?1:4===t?-1:0)},g.frontYAligned=function(e,t){return Math.round(e)+(2===t?1:8===t?-1:0)},g.roundXWithDirection=function(e,t){return $gameMap.roundX(e+(6===t?1:4===t?-1:0))},g.roundYWithDirection=function(e,t){return $gameMap.roundY(e+(2===t?1:8===t?-1:0))},g.roundXWithDirectionLong=function(e,t,i){for(var r=g.roundXWithDirection(e,t),n=Math.floor(i),a=0;a<n-1;a++)r=g.roundXWithDirection(r,t);var o=i-Math.floor(i);return 0<o&&(r+=g.roundXWithDirection(0,t)*o),r},g.roundYWithDirectionLong=function(e,t,i){for(var r=g.roundYWithDirection(e,t),n=Math.floor(i),a=0;a<n-1;a++)r=g.roundYWithDirection(r,t);var o=i-Math.floor(i);return 0<o&&(r+=g.roundYWithDirection(0,t)*o),r},g.checkFacingOutsideOnEdgeTile=function(e,t,i){var r=Math.round(e),n=Math.round(t);return!$gameMap.checkPassage(r,n,1<<i/2-1&15)},g.checkFacingOtherEdgeTile=function(e,t,i,r){var n=Math.round(g.roundXWithDirectionLong(e,i,r)),a=Math.round(g.roundYWithDirectionLong(t,i,r));return!$gameMap.isPassable(n,a,g.reverseDir(i))},g.canPassJumpGroove=function(e,t,i,r){if(2!=r&&8!=r||!g.isHalfStepX(e))return g.canPassJumpGrooveInternal(e,t,i,r);var n=g.canPassJumpGrooveInternal(e,t-1,i,r),a=g.canPassJumpGrooveInternal(e,t,i,r);return!(!n||!a)&&a},g.canPassJumpGrooveInternal=function(e,t,i,r){var n=Math.round(t),a=Math.round(i),o=Math.round(g.roundXWithDirectionLong(t,r,2)),s=Math.round(g.roundYWithDirectionLong(i,r,2)),c=Math.round(g.roundXWithDirectionLong(t,r,1)),p=Math.round(g.roundYWithDirectionLong(i,r,1)),h=g.roundXWithDirectionLong(t,r,2),u=g.roundYWithDirectionLong(i,r,2);if(!$gameMap.isValid(o,s))return!1;if(!$gameMap.isPassable(n,a,r))return!1;var l=e.reverseDir(r);return!!$gameMap.isPassable(o,s,l)&&!e.isCollidedWithCharacters(h,u)&&!!$gameMap.checkGroove(c,p)},g.checkJumpGroundToGroundInternal=function(e,t,i,r,n){var a=Math.round(t),o=Math.round(i),s=g.roundXWithDirectionLong(t,r,n),c=g.roundYWithDirectionLong(i,r,n),p=Math.round(s),h=Math.round(c);if(!$gameMap.isValid(p,h))return{pass:!1,x:0,y:0};var u=e.reverseDir(r);if($gameMap.isPassable(a,o,r)||$gameMap.isPassable(p,h,u))return{pass:!1,x:0,y:0};if($gameMap.checkNotPassageAll(p,h))return{pass:!1,x:0,y:0};if(e.isCollidedWithCharacters(s,c))return{pass:!1,x:0,y:0};var l=g.roundXWithDirectionLong(t,r,1),d=g.roundYWithDirectionLong(i,r,1);return g.isCollidedWithRiddingEvents(l,d)?{pass:!1,x:0,y:0}:{pass:!0,x:s,y:c}},g.checkMoveOrJumpGroundToObject=function(e,t,i,r,n){var a=Math.round(e),o=Math.round(t),s=Math.round(g.roundXWithDirectionLong(e,i,r)),c=Math.round(g.roundYWithDirectionLong(t,i,r));if(n||!$gameMap.isPassable(a,o,i)){var p=g.findPassableRideObject(s,c);return p||void 0}},g.checkMoveOrJumpObjectToGround=function(e,t,i,r,n){var a=Math.round(g.roundXWithDirectionLong(t,r,n)),o=Math.round(g.roundYWithDirectionLong(i,r,n));if(e.isBoxType()&&!e.isFalling()&&$gameMap.terrainTag(a,o)!=c.paramGuideLineTerrainTag)return!1;var s=e.reverseDir(r);return!$gameMap.isPassable(a,o,s)&&!$gameMap.checkNotPassageAll(a,o)&&!e.isCollidedWithCharacters(a,o)},g.checkMoveOrJumpObjectToObject=function(e,t,i,r){var n=Math.round(g.roundXWithDirectionLong(e,i,r)),a=Math.round(g.roundYWithDirectionLong(t,i,r)),o=g.findPassableRideObject(n,a);if(o)return o},g.isCollidedWithRiddingEvents=function(e,t){return $gameMap.eventsXyNt(e,t).some(function(e){return e.isRidding()})},g.findPassableRideObject=function(e,t){for(var i=$gameMap.events(),r=0;r<i.length;r++)if(i[r].checkPassRide(e,t))return i[r]},g.getCharacterById=function(e){return 0==e?$gamePlayer:$gameMap.events()[e-1]},g.findReactorMapObjectInLineRange=function(e,t,i,r,n){var a=n.toLocaleLowerCase(),o=0;$gameMap.isPassable(e,t,i)||o--;for(var s=0;s<r;s++){var c=Math.round(g.roundXWithDirectionLong(e,i,s+1)),p=Math.round(g.roundYWithDirectionLong(t,i,s+1)),h=this.reverseDir(i);if($gameMap.isPassable(c,p,h)||o++,0===o)for(var u=$gameMap.eventsXyNt(c,p),l=0;l<u.length;l++){var d=u[l];if(d.isMapObject()&&d.reactionMapSkill()==a)return d}if($gameMap.isValid(c,p-1)&&g.checkLayeredTilesFlags($gameMap,c,p-1,16))return;if($gameMap.eventsXyNt(c,p).some(function(e){return 1<=e.objectHeight()}))return;$gameMap.isPassable(c,p,i)||o--}},g.canPassJumpGroundToGround=function(e,t,i,r){if(Math.round(t),Math.round(i),Math.round(g.roundXWithDirectionLong(t,r,2)),Math.round(g.roundYWithDirectionLong(i,r,2)),2==r||8==r){var n=2-(i-Math.floor(i));if(g.isHalfStepX(e)){var a=g.checkJumpGroundToGroundInternal(e,t-1,i,r,n),o=g.checkJumpGroundToGroundInternal(e,t,i,r,n);return!(!a.pass||!o.pass)&&o.pass}return g.checkJumpGroundToGroundInternal(e,t,i,r,n).pass}if(!g.isHalfStepY(e)||4!=r&&6!=r)return g.checkJumpGroundToGroundInternal(e,t,i,r,2).pass;if(!(a=g.checkJumpGroundToGroundInternal(e,t,i,r,2)).pass)return!1;var s=a.x,c=Math.ceil(a.y);return!(e.isCollidedWithCharacters(s,c)&&!(o=g.checkJumpGroundToGroundInternal(e,Math.round(t),c-1,r,2)).pass)&&a.pass},g.findObject=function(e,t){for(var i=$gameMap.eventsXyNt(e,t),r=0;r<i.length;r++)if(i[r].isMapObject())return i[r]},g.checkLayeredTilesFlags=function(e,t,i,r){var n=e.tilesetFlags();return e.layeredTiles(t,i).some(function(e){return 0!==e&&0!=(n[e]&r)})},g.reverseDir=function(e){return 10-e},g.linear=function(e,t,i,r){return i*(e/r)+t},g.easeInExpo=function(e,t,i,r){return i*Math.pow(2,10*(e/r-1))+t},g.distance2D=function(e,t,i,r){var n=i-e,a=r-t;return Math.sqrt(n*n+a*a)},g);function g(){}t.MovingHelper=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r={name:"Evasion1",volume:80,pitch:110,pan:0},n={name:"Earth3",volume:80,pitch:100,pan:0},a=SoundManager.preloadImportantSounds;SoundManager.preloadImportantSounds=function(){a.call(SoundManager),$dataSystem&&AudioManager.loadStaticSe(r)};var o=(s.playGSJump=function(){$dataSystem&&AudioManager.playStaticSe(r)},s.playGSFalled=function(){AudioManager.playSe(n)},s);function s(){}t.AMPS_SoundManager=o},function(e,t,i){"use strict";var r,n=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});Object.defineProperty(t,"__esModule",{value:!0});var c=i(3),a=(o.prototype.attachMovingSequel=function(e,t){this._ownerCharacterId=e.objectId(),this._targetCharacterId=t.objectId(),e._movingSequel=this,t._movingSequelOwnerCharacterId=this._ownerCharacterId},o.prototype.detach=function(){this.ownerCharacter()._movingSequel=void 0,this.targetCharacter()._movingSequelOwnerCharacterId=-1,this._ownerCharacterId=-1,this._targetCharacterId=-1},o.prototype.ownerCharacter=function(){return c.MovingHelper.getCharacterById(this._ownerCharacterId)},o.prototype.targetCharacter=function(){return c.MovingHelper.getCharacterById(this._targetCharacterId)},o.prototype.onOwnerUpdate=function(e){return!1},o.prototype.onOwnerStepEnding=function(e){},o.prototype.onTargetUpdate=function(e){return!1},o.prototype.onTargetStepEnding=function(e){},o);function o(){this._ownerCharacterId=-1,this._targetCharacterId=-1}t.MovingSequel=a;var s,p=(n(h,s=a),h.checkPushable=function(e){return e.isBoxType()&&!e.rider()},h.tryStartPushObjectAndMove=function(e,t){if(!e.isMover())return!1;var i=c.MovingHelper.roundXWithDirectionLong(e._x,t,1),r=c.MovingHelper.roundYWithDirectionLong(e._y,t,1),n=c.MovingHelper.findObject(i,r);if(!n)return!1;if(!this.checkPushable(n))return!1;if(n.isRidding()){if(!e.isRidding()&&!c.MovingHelper.checkFacingOutsideOnEdgeTile(e._x,e._y,t))return!1}else{var a=c.MovingHelper.checkFacingOutsideOnEdgeTile(e._x,e._y,t),o=c.MovingHelper.checkFacingOutsideOnEdgeTile(n._x,n._y,e.reverseDir(t));if(e.isRidding()){if(!o)return!1}else if(a||o)return!1}if(this.tryMoveAsPushableObject(n,t)){var s=new h;if(s._ownerOrignalMovingSpeed=e.moveSpeed(),e.setMoveSpeed(n.moveSpeed()),n.isOnSlipperyTile())return s.attachMovingSequel(e,n),s.onOwnerStepEnding(e),!0;if(e._forcePositionAdjustment=!0,e.moveStraightMain(t),e._forcePositionAdjustment=!1,e.isMovementSucceeded(e.x,e.y))return s.attachMovingSequel(e,n),!0}return!1},h.tryMoveAsPushableObject=function(e,t){if(e.isRidding()){if(e.attemptMoveObjectToObject(t))return!0;if(e.attemptMoveObjectToGround(t))return!0}else{if(e.attemptMoveGroundToGround(t))return!0;if(e.attemptMoveGroundToObject(t,!1))return!0}return!1},h.prototype.onOwnerUpdate=function(e){return!1},h.prototype.onOwnerStepEnding=function(e){e.setMoveSpeed(this._ownerOrignalMovingSpeed),this._ownerStepEnded=!0,this.tryDetach()},h.prototype.onTargetStepEnding=function(e){this._targetStepEnded=!0,e.isFalling()||this.tryDetach()},h.prototype.tryDetach=function(){this._ownerStepEnded&&this._targetStepEnded&&this.detach()},h);function h(){var e=s.call(this)||this;return e._ownerOrignalMovingSpeed=0,e._ownerStepEnded=!1,e._targetStepEnded=!1,e}t.MovingSequel_PushMoving=p},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),i(0),i(1),i(4),i(5),i(7),i(8),i(9),i(10),i(11),i(12),i(13),i(14)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,n,o=i(2),c=i(3),p=i(4),a=i(5),s=i(0);(n=r=r||{})[n.None=0]="None",n[n.Failling=1]="Failling",n[n.EpilogueToRide=2]="EpilogueToRide";var h=Game_CharacterBase.prototype.initMembers;Game_CharacterBase.prototype.initMembers=function(){h.call(this),this._objectTypeBox=!1,this._objectTypeEffect=!1,this._objectTypeReactor=!1,this._ridderCharacterId=-1,this._riddeeCharacterId=-1,this._waitAfterJump=0,this._extraJumping=!1,this._ridingScreenZPriority=-1,this._movingMode=o.MovingMode.Stopping,this._movingDirection=0,this._forcePositionAdjustment=!1,this._moveToFalling=!1,this._fallingState=r.None,this._fallingOriginalSpeed=0,this._fallingOriginalThrough=!1,this._movingSequel=void 0,this._movingSequelOwnerCharacterId=-1,this._getonoffFrameCount=0,this._getonoffFrameMax=0,this._getonoffStartX=0,this._getonoffStartY=0};var u=Game_CharacterBase.prototype.moveStraight;Game_CharacterBase.prototype.moveStraight=function(e){if($gameMap.isPuzzleEnabled()){if(o.assert(2==e||4==e||6==e||8==e),0<this._waitAfterJump)return void this._waitAfterJump--;if(a.MovingSequel_PushMoving.tryStartPushObjectAndMove(this,e))return;this.moveStraightMain(e)}else u.call(this,e)};var l=Game_CharacterBase.prototype.moveDiagonally;Game_CharacterBase.prototype.moveDiagonally=function(e,t){this.isRidding()||l.call(this,e,t)},Game_CharacterBase.prototype.isRidding=function(){return 0<=this._riddeeCharacterId},Game_CharacterBase.prototype.isMapObject=function(){return this.isBoxType()||this.isEffectType()||this.isReactorType()},Game_CharacterBase.prototype.isBoxType=function(){return this._objectTypeBox},Game_CharacterBase.prototype.isEffectType=function(){return this._objectTypeEffect},Game_CharacterBase.prototype.isReactorType=function(){return this._objectTypeReactor},Game_CharacterBase.prototype.objectId=function(){return-1},Game_CharacterBase.prototype.objectHeight=function(){return-1},Game_CharacterBase.prototype.isMover=function(){return!this._objectTypeBox},Game_CharacterBase.prototype.canRide=function(){return 0<=this.objectHeight()},Game_CharacterBase.prototype.checkPassRide=function(e,t){if(this.canRide()&&!this.rider()){var i=Math.round(this._x),r=Math.round(this._y)-this.objectHeight();if(e==i&&t==r)return!0}return!1},Game_CharacterBase.prototype.rider=function(){return this._ridderCharacterId<0?void 0:0==this._ridderCharacterId?$gamePlayer:$gameMap.event(this._ridderCharacterId)},Game_CharacterBase.prototype.riddingObject=function(){return this._riddeeCharacterId<0?void 0:0==this._riddeeCharacterId?$gamePlayer:$gameMap.event(this._riddeeCharacterId)},Game_CharacterBase.prototype.isFalling=function(){return this._fallingState!=r.None},Game_CharacterBase.prototype.isOnSlipperyTile=function(){return $gameMap.isSlipperyTile(this._x,this._y)};var d=Game_CharacterBase.prototype.pattern;Game_CharacterBase.prototype.pattern=function(){return this.isOnSlipperyTile()?s.paramSlippingAnimationPattern:d.call(this)};var g=Game_CharacterBase.prototype.screenZ;Game_CharacterBase.prototype.screenZ=function(){var e=g.call(this),t=this.riddingObject();return this.isRidding()&&t&&(e+=t.screenZ()),0<=this._ridingScreenZPriority&&(e=this._ridingScreenZPriority),e+(this._extraJumping?6:0)},Game_CharacterBase.prototype.moveStraightMain=function(e){this.setMovementSuccess(!1),this.isRidding()?(this.attemptMoveObjectToGround(e)||this.attemptMoveObjectToObject(e)||this.attemptJumpObjectToGround(e)||this.attemptJumpObjectToObject(e),this.setDirection(e)):this.attemptMoveGroundToGround(e)||this.attemptMoveGroundToObject(e,!1)||this.attemptJumpGroundToGround(e)||this.attemptJumpGroove(e)||this.attemptJumpGroundToObject(e)},Game_CharacterBase.prototype.attemptMoveGroundToGround=function(e){if(this.isBoxType()&&!this.isThrough()){var t=Math.round(c.MovingHelper.roundXWithDirectionLong(this._x,e,1)),i=Math.round(c.MovingHelper.roundYWithDirectionLong(this._y,e,1));if($gameMap.terrainTag(t,i)==s.paramGuideLineTerrainTag&&this.isMapPassable(this._x,this._y,e)&&(u.call(this,e),this.isMovementSucceeded(this.x,this.y)))return this._movingDirection=e,!0;if(this.isFallable()&&$gameMap.terrainTag(this._x,this._y)==s.paramGuideLineTerrainTag&&c.MovingHelper.checkFacingOutsideOnEdgeTile(this._x,this._y,e)&&!c.MovingHelper.checkMoveOrJumpObjectToObject(this._x,this._y,e,1))return this.moveToDir(e,!1),this.setMovementSuccess(!0),this._movingDirection=e,this._moveToFalling=!0}else{var r=this._x,n=this._y;if(u.call(this,e),this._movementSuccess)return this._movingDirection=e,this._forcePositionAdjustment&&(this._x=Math.round(c.MovingHelper.roundXWithDirection(r,e)),this._y=Math.round(c.MovingHelper.roundYWithDirection(n,e))),this._movingMode=o.MovingMode.GroundToGround,!0}return!1},Game_CharacterBase.prototype.attemptJumpGroundToGround=function(e){return!!c.MovingHelper.canPassJumpGroundToGround(this,this._x,this._y,e)&&(this.setMovementSuccess(!0),this._movingDirection=e,this.jumpToDir(e,2,!1,!0),this._movingMode=o.MovingMode.GroundToGround,!0)},Game_CharacterBase.prototype.attemptJumpGroove=function(e){return!!c.MovingHelper.canPassJumpGroove(this,this._x,this._y,e)&&(this.setMovementSuccess(!0),this._movingDirection=e,this.jumpToDir(e,2,!1,!1),this._movingMode=o.MovingMode.GroundToGround,!0)},Game_CharacterBase.prototype.attemptMoveGroundToObject=function(e,t){var i=c.MovingHelper.checkMoveOrJumpGroundToObject(this._x,this._y,e,1,t);return!(!i||i==this)&&(this.setMovementSuccess(!0),this._movingDirection=e,this.resetGetOnOffParams(),this.moveToDir(e,!0),this.rideToObject(i),this._movingMode=o.MovingMode.GroundToObject,!0)},Game_CharacterBase.prototype.attemptJumpGroundToObject=function(e){var t=c.MovingHelper.checkMoveOrJumpGroundToObject(this._x,this._y,e,2,!1);return!(!t||t==this)&&(this.setMovementSuccess(!0),this._movingDirection=e,this.resetGetOnOffParams(),this.jumpToDir(e,2,!0,!0),this.rideToObject(t),this._movingMode=o.MovingMode.GroundToObject,!0)},Game_CharacterBase.prototype.attemptMoveObjectToGround=function(e){return o.assert(this.isRidding()),c.MovingHelper.checkMoveOrJumpObjectToGround(this,this._x,this._y,e,1)?(this.setMovementSuccess(!0),this._movingDirection=e,this.resetGetOnOffParams(),this.moveToDir(e,!1),this.unrideFromObject(),this._movingMode=o.MovingMode.ObjectToGround,!0):!(!this.isBoxType()||!this.isFallable()||c.MovingHelper.checkFacingOtherEdgeTile(this._x,this._y,e,1))&&(this.setMovementSuccess(!0),this._movingDirection=e,this.resetGetOnOffParams(),this.moveToDir(e,!1),this.unrideFromObject(),this._moveToFalling=!0)},Game_CharacterBase.prototype.attemptMoveObjectToObject=function(e){o.assert(this.isRidding());var t=c.MovingHelper.checkMoveOrJumpObjectToObject(this._x,this._y,e,1);return!(!t||t==this)&&(this.setMovementSuccess(!0),this._movingDirection=e,this.resetGetOnOffParams(),this.moveToDir(e,!1),this.unrideFromObject(),this.rideToObject(t),this._movingMode=o.MovingMode.ObjectToObject,!0)},Game_CharacterBase.prototype.attemptJumpObjectToGround=function(e){return!!c.MovingHelper.checkMoveOrJumpObjectToGround(this,this._x,this._y,e,2)&&(this.setMovementSuccess(!0),this._movingDirection=e,this.jumpToDir(e,2,!1,!0),this._movingMode=o.MovingMode.ObjectToGround,!0)},Game_CharacterBase.prototype.attemptJumpObjectToObject=function(e){var t=c.MovingHelper.checkMoveOrJumpObjectToObject(this._x,this._y,e,2);return!!t&&(this.setMovementSuccess(!0),this._movingDirection=e,this.resetGetOnOffParams(),this.jumpToDir(e,2,!0,!0),this.rideToObject(t),this._movingMode=o.MovingMode.ObjectToObject,!0)};var f=Game_CharacterBase.prototype.jump;Game_CharacterBase.prototype.jump=function(e,t){f.call(this,e,t),this.isRidding()&&this.unrideFromObject()},Game_CharacterBase.prototype.rideToObject=function(e){o.assert(!this.isRidding()),o.assert(0<=this.objectId()),o.assert(0<=e.objectId()),this._riddeeCharacterId=e.objectId(),e._ridderCharacterId=this.objectId(),o.assert(this._riddeeCharacterId!=e._ridderCharacterId);var t=this._ridingScreenZPriority;this._ridingScreenZPriority=-1,this._ridingScreenZPriority=this.screenZ(),this._ridingScreenZPriority=Math.max(this._ridingScreenZPriority,t)},Game_CharacterBase.prototype.unrideFromObject=function(){o.assert(this.isRidding());var e=this.riddingObject();e&&(e._ridderCharacterId=-1),this._riddeeCharacterId=-1},Game_CharacterBase.prototype.moveToDir=function(e,t){this._x=$gameMap.roundXWithDirection(this._x,e),this._y=$gameMap.roundYWithDirection(this._y,e),(t||this._forcePositionAdjustment)&&(this._y=Math.round(this._y)),this._forcePositionAdjustment&&(this._x=Math.round(this._x))},Game_CharacterBase.prototype.jumpToDir=function(e,t,i,r){var n=this._x,a=this._y;i||(n=Math.round(this._x),2==e||8==e||(a=Math.round(this._y)));var o=Math.round(c.MovingHelper.roundXWithDirectionLong(this._x,e,t)),s=Math.round(c.MovingHelper.roundYWithDirectionLong(this._y,e,t));this.jump(o-n,s-a),this._waitAfterJump=10,this._extraJumping=r,p.AMPS_SoundManager.playGSJump()},Game_CharacterBase.prototype.startFall=function(){this._fallingState=r.Failling,this._fallingOriginalThrough=this.isThrough(),this._fallingOriginalSpeed=this.moveSpeed(),this.setThrough(!0),this.setMoveSpeed(s.paramFallingSpeed),this.onStartFalling()};var v=Game_CharacterBase.prototype.isMoving;Game_CharacterBase.prototype.isMoving=function(){return(!this.isRidding()||this._movingMode!=o.MovingMode.Stopping)&&v.call(this)};var m=Game_CharacterBase.prototype.update;Game_CharacterBase.prototype.update=function(){if(!this._movingSequel||!this._movingSequel.onOwnerUpdate(this)){if(0<=this._movingSequelOwnerCharacterId){var e=c.MovingHelper.getCharacterById(this._movingSequelOwnerCharacterId);if(e._movingSequel&&e._movingSequel.onTargetUpdate(this))return}var t;m.call(this),this.isFalling()&&this.updateFall(),!this.isRidding()||this._movingMode!=o.MovingMode.Stopping||(t=this.riddingObject())&&(this._x=t._x,this._y=t._y-t.objectHeight(),this._realX=t._realX,this._realY=t._realY-t.objectHeight())}};var _=Game_CharacterBase.prototype.updateStop;Game_CharacterBase.prototype.updateStop=function(){_.call(this),this.isRidding()||(this._ridingScreenZPriority=-1),this._movingMode=o.MovingMode.Stopping};var M=Game_CharacterBase.prototype.updateMove;Game_CharacterBase.prototype.updateMove=function(){var e,t,i,r,n=this.isMoving();this.isMoving()&&this._movingMode!=o.MovingMode.Stopping&&this._movingMode!=o.MovingMode.GroundToGround?(this._getonoffFrameCount++,t=e=0,this._movingMode==o.MovingMode.GroundToObject||this._movingMode==o.MovingMode.ObjectToObject?(i=this.riddingObject())&&(e=i._realX,t=i._realY-i.objectHeight()):this._movingMode==o.MovingMode.ObjectToGround&&(e=this._x,t=this._y),r=Math.min(this._getonoffFrameCount/this._getonoffFrameMax,1),this._realX=c.MovingHelper.linear(r,this._getonoffStartX,e-this._getonoffStartX,1),this._realY=c.MovingHelper.linear(r,this._getonoffStartY,t-this._getonoffStartY,1),this._getonoffFrameCount>=this._getonoffFrameMax&&(this._movingMode=o.MovingMode.Stopping)):M.call(this),n==this.isMoving()||this.isMoving()||(this._moveToFalling?(this._moveToFalling=!1,this.startFall()):this.raiseStepEnd())};var y=Game_CharacterBase.prototype.updateJump;Game_CharacterBase.prototype.updateJump=function(){var e,t,i,r,n,a=this.isJumping();y.call(this),this.isRidding()&&a&&(this._movingMode!=o.MovingMode.GroundToObject&&this._movingMode!=o.MovingMode.ObjectToObject||(e=this.riddingObject())&&(t=e._realX,i=e._realY-e.objectHeight(),r=2*this._jumpPeak,n=Math.min((r-this._jumpCount+1)/r,1),this._realX=c.MovingHelper.linear(n,this._getonoffStartX,t-this._getonoffStartX,1),this._realY=c.MovingHelper.linear(n,this._getonoffStartY,i-this._getonoffStartY,1),this._x=e._x,this._y=e._y-e.objectHeight())),this.isJumping()||(this._extraJumping=!1,this._movingMode=o.MovingMode.Stopping,a!=this.isJumping()&&this.onJumpEnd())},Game_CharacterBase.prototype.updateFall=function(){this.isMoving()||(this._fallingState==r.Failling&&($gameMap.terrainTag(this._x,this._y)==s.paramGuideLineTerrainTag||this.attemptMoveGroundToObject(2,!0)?this._fallingState=r.EpilogueToRide:this.moveStraightMain(2)),this._fallingState==r.EpilogueToRide&&(this._fallingState=r.None,this.setThrough(this._fallingOriginalThrough),this.setMoveSpeed(this._fallingOriginalSpeed),this.raiseStepEnd(),p.AMPS_SoundManager.playGSFalled()))},Game_CharacterBase.prototype.resetGetOnOffParams=function(){this._getonoffFrameMax=1/this.distancePerFrame(),this._getonoffFrameCount=0,this._getonoffStartX=this._realX,this._getonoffStartY=this._realY},Game_CharacterBase.prototype.raiseStepEnd=function(){this.onStepEnd(),this.isOnSlipperyTile()?($gameTemp.clearDestination(),this.moveStraight(this._movingDirection),this.isMovementSucceeded(this.x,this.y)||this.raiseStop()):this.raiseStop()},Game_CharacterBase.prototype.raiseStop=function(){this.onStop()},Game_CharacterBase.prototype.onStepEnd=function(){},Game_CharacterBase.prototype.onStop=function(){var e;this._movingSequel&&this._movingSequel.onOwnerStepEnding(this),0<=this._movingSequelOwnerCharacterId&&((e=c.MovingHelper.getCharacterById(this._movingSequelOwnerCharacterId))._movingSequel&&e._movingSequel.onTargetStepEnding(this)),this.isRidding()||(this._ridingScreenZPriority=-1);var t=this.riddingObject();t&&t.onRideOnEvent()},Game_CharacterBase.prototype.onJumpEnd=function(){var e=this.riddingObject();e&&e.onRideOnEvent()},Game_CharacterBase.prototype.onRideOnEvent=function(){},Game_CharacterBase.prototype.onStartFalling=function(){};var S=Game_CharacterBase.prototype.isHalfMove;Game_CharacterBase.prototype.isHalfMove=function(){return!!this.isMover()&&(!this._forcePositionAdjustment&&(!!S&&S.call(this)))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Game_Player.prototype.objectId=function(){return 0};var r=Game_Player.prototype.isCollided;Game_Player.prototype.isCollided=function(e,t){return!this.isRidding()&&r.call(this,e,t)};var n=Game_Player.prototype.canMove;Game_Player.prototype.canMove=function(){return!this._movingSequel&&n.call(this)};var a=Game_Player.prototype.isDashing;Game_Player.prototype.isDashing=function(){return!this._movingSequel&&(!this.isOnSlipperyTile()&&a.call(this))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s,r,n=i(0),c=i(2),a=i(1),o=i(3);(r=s=s||{})[r.Default=0]="Default",r[r.Front=1]="Front",Game_Event.prototype.clearMapObjectSettings=function(){this._objectTypeBox=!1,this._objectTypeEffect=!1,this._objectTypeReactor=!1,this._objectHeight=-1,this._fallable=!1,this._mapObjectEventTrigger=c.EventTrigger.None,this._mapSkillRange=-1,this._reactionMapSkill="",this._mapSkillEffectInitialPosition=s.Default};var p=Game_Event.prototype.initMembers;Game_Event.prototype.initMembers=function(){p.call(this),this._objectHeight=-1,this._fallable=!1,this._mapObjectEventTrigger=c.EventTrigger.None,this._mapSkillEffectDataId=a.AMPSManager.tempMapSkillEffectDataId,this._mapSkillEffectInvokerId=a.AMPSManager.tempMapSkillEffectInvokerId,this._mapSkillEffectInitialPosition=s.Default};var h=Game_Event.prototype.event;Game_Event.prototype.event=function(){if(0<n.paramMapSkillEffectsMapId){var e=a.AMPSManager.dataMapSkillEffectsMap();if(e&&e.events&&this.isDynamicMapEffectEvent())return e.events[this._mapSkillEffectDataId]}return h.call(this)};var u=Game_Event.prototype.isTriggerIn;Game_Event.prototype.isTriggerIn=function(e){return this._mapObjectEventTrigger===c.EventTrigger.None&&u.call(this,e)};var l=Game_Event.prototype.checkEventTriggerTouch;Game_Event.prototype.checkEventTriggerTouch=function(e,t){this._mapObjectEventTrigger!==c.EventTrigger.None||l.call(this,e,t)};var d=Game_Event.prototype.checkEventTriggerAuto;Game_Event.prototype.checkEventTriggerAuto=function(){this._mapObjectEventTrigger!==c.EventTrigger.None||d.call(this)},Game_Event.prototype.objectId=function(){return this.eventId()},Game_Event.prototype.objectHeight=function(){return this._objectHeight},Game_Event.prototype.isFallable=function(){return this._fallable},Game_Event.prototype.isDynamicMapEffectEvent=function(){return this._mapId===n.paramMapSkillEffectsMapId&&0<=this._mapSkillEffectDataId},Game_Event.prototype.reactionMapSkill=function(){return this._reactionMapSkill},Game_Event.prototype.mapSkillEffectInvoker=function(){return this._mapSkillEffectInvokerId<0?void 0:0==this._mapSkillEffectInvokerId?$gamePlayer:$gameMap.event(this._mapSkillEffectInvokerId)},Game_Event.prototype.directionAsMapSkillEffect=function(){var e=this.mapSkillEffectInvoker();return e?e.direction():this.direction()};var g=Game_Event.prototype.refresh;Game_Event.prototype.refresh=function(){g.call(this);var e=this.mapSkillEffectInvoker();e&&((this._mapSkillEffectInitialPosition=s.Front)?this.locate(o.MovingHelper.frontX(e.x,e.direction()),o.MovingHelper.frontY(e.y,e.direction())):this.locate(e.x,e.y))};var f=Game_Event.prototype.setupPage;Game_Event.prototype.setupPage=function(){var e,t,i,r=this.objectHeight(),n=this.rider();f.call(this),!this.isMapObject()&&n&&n.jump(0,r),this.isEffectType()&&this._mapObjectEventTrigger==c.EventTrigger.OnSpawnedAsEffect&&(!(t=this.mapSkillEffectInvoker())||(i=o.MovingHelper.findReactorMapObjectInLineRange(t.x,t.y,this.directionAsMapSkillEffect(),this._mapSkillRange,null!==(e=this.event().name)&&void 0!==e?e:""))&&i.startAsReactor())};var v=Game_Event.prototype.clearPageSettings;Game_Event.prototype.clearPageSettings=function(){v.call(this),this.clearMapObjectSettings()};var m=Game_Event.prototype.setupPageSettings;Game_Event.prototype.setupPageSettings=function(){m.call(this),this.parseListCommentForAMPSObject(),this._mapObjectEventTrigger!=c.EventTrigger.None&&(this._interpreter=null)},Game_Event.prototype.parseListCommentForAMPSObject=function(){if(this.clearMapObjectSettings(),0<=this._pageIndex){var e=this.list();if(e){for(var t="",i=0;i<e.length;i++)108!=e[i].code&&408!=e[i].code||e[i].parameters&&(t+=e[i].parameters);var r=t.indexOf("@MapObject");if(0<=r){for(var n=t.substring(r+6),a=(n=n.substring(n.indexOf("{")+1,n.indexOf("}"))).split(","),i=0;i<a.length;i++){var o=a[i].split(":");switch(o[0].trim().toLocaleLowerCase()){case"type":switch(console.error("@MapObject.type is deprecated. use 'box:true'"),o[1].trim().toLocaleLowerCase()){case"box":this._objectTypeBox=!0;break;case"effect":this._objectTypeEffect=!0;break;case"reactor":this._objectTypeReactor=!0}break;case"box":this._objectTypeBox=!(2<=o.length)||Boolean(o[1].trim());break;case"effect":this._objectTypeEffect=!(2<=o.length)||Boolean(o[1].trim());break;case"reactor":this._objectTypeReactor=!(2<=o.length)||Boolean(o[1].trim());break;case"h":case"height":this._objectHeight=Number(o[1].trim());break;case"fallable":this._fallable="true"==o[1].trim();break;case"trigger":this._mapObjectEventTrigger=c.strToEventTrigger(o[1].trim());break;case"range":this._mapSkillRange=Number(o[1].trim());break;case"reaction":this._reactionMapSkill=o[1].trim().toLocaleLowerCase();break;case"pos":switch(o[1].trim().toLocaleLowerCase()){case"front":this._mapSkillEffectInitialPosition=s.Front}}}return!0}}}return!1};var _=Game_Event.prototype.start;Game_Event.prototype.start=function(){this.isReactorType()||_.call(this)},Game_Event.prototype.startAsReactor=function(){_.call(this)};var M=Game_Event.prototype.updateParallel;Game_Event.prototype.updateParallel=function(){var e;this._interpreter?(e=this._interpreter.isRunning(),M.call(this),e&&!this._interpreter.isRunning()&&this.onTerminateParallelEvent()):M.call(this)},Game_Event.prototype.onTerminateParallelEvent=function(){this.isDynamicMapEffectEvent()&&$gameMap.despawnMapSkillEffectEvent(this)},Game_Event.prototype.onRideOnEvent=function(){this._mapObjectEventTrigger===c.EventTrigger.OnRideOnEvent&&this.start()},Game_Event.prototype.onStartFalling=function(){this._mapObjectEventTrigger===c.EventTrigger.OnStartFalling&&this.start()}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=i(0),o=i(1),c=i(2),r=Game_Map.prototype.setup;Game_Map.prototype.setup=function(e){r.call(this,e),$dataMap.meta.LNPuzzleEnable||!this.isOverworld()&&s.paramAllowAllMapPuzzles?this._puzzleEnabled=!0:this._puzzleEnabled=!1},Game_Map.prototype.isPuzzleEnabled=function(){return this._puzzleEnabled},Game_Map.prototype.checkPassage=function(e,t,i){for(var r=this.tilesetFlags(),n=this.allTiles(e,t),a=0;a<n.length;a++){var o=r[n[a]];if(r[n[a]]>>12!=s.paramGuideLineTerrainTag&&0==(16&o)){if(0==(o&i))return!0;if((o&i)===i)return!1}}return!1},Game_Map.prototype.checkNotPassageAll=function(e,t){for(var i=this.tilesetFlags(),r=this.allTiles(e,t),n=0,a=0;a<r.length;a++){n|=i[r[a]]}return 15==(15&n)},Game_Map.prototype.checkGroove=function(e,t){for(var i=this.allTiles(e,t),r=0;r<i.length;r++)if(Tilemap.isTileA1(i[r]))return!0;return!1},Game_Map.prototype.spawnMapSkillEffectEvent=function(e){c.assert(0<s.paramMapSkillEffectsMapId);var t=o.AMPSManager.dataMapSkillEffectsMap();if(t&&t.events){for(var i=-1,r=0;r<t.events.length;r++)if(t.events[r]&&t.events[r].name==e){i=r;break}if(0<=i){o.AMPSManager.tempMapSkillEffectDataId=i,o.AMPSManager.tempMapSkillEffectInvokerId=0;var n=this._events.length,a=new Game_Event(s.paramMapSkillEffectsMapId,n);return o.AMPSManager.tempMapSkillEffectDataId=-1,o.AMPSManager.tempMapSkillEffectInvokerId=-1,a._eventIndex=n,this._events[n]=a,this._spawnMapSkillEffectEventcallback&&this._spawnMapSkillEffectEventcallback(a),a}}},Game_Map.prototype.despawnMapSkillEffectEvent=function(e){c.assert(0<=e._eventIndex),this._events.splice(e._eventIndex,1),this._despawnMapSkillEffectEventcallback&&this._despawnMapSkillEffectEventcallback(e)},Game_Map.prototype.setSpawnMapSkillEffectEventHandler=function(e){this._spawnMapSkillEffectEventcallback=e},Game_Map.prototype.setDespawnMapSkillEffectEventHandler=function(e){this._despawnMapSkillEffectEventcallback=e},Game_Map.prototype.isSlipperyTile=function(e,t){return 0!==s.paramSlipRegion&&this.regionId(e,t)===s.paramSlipRegion}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=i(1),n=Game_Interpreter.prototype.pluginCommand;Game_Interpreter.prototype.pluginCommand=function(e,t){n.call(this,e,t),r.AMPSManager.pluginCommand(e,t)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=i(2),n=Spriteset_Map.prototype.createCharacters;Spriteset_Map.prototype.createCharacters=function(){n.call(this),$gameMap.setSpawnMapSkillEffectEventHandler(this.onSpawnMapSkillEffectEvent.bind(this)),$gameMap.setDespawnMapSkillEffectEventHandler(this.onDespawnMapSkillEffectEvent.bind(this))},Spriteset_Map.prototype.onSpawnMapSkillEffectEvent=function(e){r.assert(null!=e._eventIndex);var t=new Sprite_Character(e);this._characterSprites.push(t),this._tilemap.addChild(t)},Spriteset_Map.prototype.onDespawnMapSkillEffectEvent=function(e){r.assert(null!=e._eventIndex);for(var t=0;t<this._characterSprites.length;t++){var i=this._characterSprites[t]._character;if(i&&null!=i._eventIndex&&i._eventIndex==e._eventIndex){this._tilemap.removeChild(this._characterSprites[t]),this._characterSprites.splice(t,1);break}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=i(1),n=Scene_Boot.prototype.create;Scene_Boot.prototype.create=function(){n.call(this),r.AMPSManager.init()}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,n,a,o,s,c=i(2);"undefined"!=typeof Sanshiro&&null!=Sanshiro.AnalogMove&&(r=Game_CharacterBase.prototype.initMembers,Game_CharacterBase.prototype.initMembers=function(){r.call(this)},n=Game_CharacterBase.prototype.updateMover,Game_CharacterBase.prototype.updateMover=function(){n.call(this),$gameMap.isPuzzleEnabled()&&this._mover.isInputed&&this._mover.isInputed()&&this.canAnalogMove()&&(6==Input.dir8&&Math.abs(this._mover._lasPosVec.x()-this._mover._posVec.x())<.005&&this.moveStraight(6),4==Input.dir8&&Math.abs(this._mover._lasPosVec.x()-this._mover._posVec.x())<.005&&this.moveStraight(4),8==Input.dir8&&Math.abs(this._mover._lasPosVec.y()-this._mover._posVec.y())<.005&&this.moveStraight(8),2==Input.dir8&&Math.abs(this._mover._lasPosVec.y()-this._mover._posVec.y())<.005&&this.moveStraight(2))},a=Game_CharacterBase.prototype.updateJump,Game_CharacterBase.prototype.updateJump=function(){a.call(this),$gameMap.isPuzzleEnabled()&&!this.isJumping()&&this.hasMover()&&this.refreshMover()},o=Game_Player.prototype.isMoving,Game_Player.prototype.isMoving=function(){return!!Game_Character.prototype.isMoving.call(this)&&(o.call(this)||this.isJumping())},s=Game_Player.prototype.shouleMoveDefault,Game_Player.prototype.shouleMoveDefault=function(){return!!this.isRidding()||(null!=this._movingSequel||(this._movingMode!=c.MovingMode.Stopping||s.call(this)))},Game_Player.prototype.updateMove=function(){this.shouleMoveDefault()&&(Game_Character.prototype.updateMove.call(this),this._moveDefault=this.isMoving())})}]);