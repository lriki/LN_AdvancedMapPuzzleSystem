//=============================================================================
// LN_AdvancedMapPuzzleSystem.js
// ----------------------------------------------------------------------------
// Copyright (c) 2020 lriki
// This software is released under the MIT License.
// http://opensource.org/licenses/mit-license.php
// ----------------------------------------------------------------------------
// [GitHub] : https://github.com/lriki/LN_AdvancedMapPuzzleSystem
// [Twitter]: https://twitter.com/lriki8
//=============================================================================

/*:ja
 * @plugindesc 謎解きマップシステムプラグイン v0.2.0
 * @author lriki
 * @param MapSkillEffectsMapId
 * @desc TODO
 * @type number
 * @default 1
 * 
 * @param GuideLineTerrainTag
 * @desc 箱オブジェクトの移動ガイドラインとなる地形タグです。
 * @type number
 * @default 7
 *
 * @help マップ上のキャラクター移動やイベントシステムを拡張し、
 * 謎解きの幅を広げるための様々な機能を追加します。
 * 
 * MIT License
 */


!function(r){var i={};function a(e){if(i[e])return i[e].exports;var t=i[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,a),t.l=!0,t.exports}a.m=r,a.c=i,a.d=function(e,t,r){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(t,e){if(1&e&&(t=a(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(a.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)a.d(r,i,function(e){return t[e]}.bind(null,i));return r},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=6)}([function(e,t,r){"use strict";var i,a,n,o;Object.defineProperty(t,"__esModule",{value:!0}),t.assert=function(e,t){if(!e)throw new Error(t)},(a=i=t.ObjectType||(t.ObjectType={}))[a.Character=0]="Character",a[a.Box=1]="Box",a[a.Effect=2]="Effect",a[a.Reactor=3]="Reactor",(o=n=t.EventTrigger||(t.EventTrigger={}))[o.None=0]="None",o[o.OnCharacterRideOn=1]="OnCharacterRideOn",o[o.OnStartedFalling=2]="OnStartedFalling",o[o.OnSpawnedAsEffect=3]="OnSpawnedAsEffect",o[o.OnCollidedAsEffect=4]="OnCollidedAsEffect",t.strToObjectType=function(e){var t=e.toLocaleLowerCase();return"box"===t?i.Box:"effect"===t?i.Effect:"reactor"===t?i.Reactor:i.Character},t.strToEventTrigger=function(e){var t=e.toLocaleLowerCase();return"oncharacterrideon"===t?n.OnCharacterRideOn:"onstartedfalling"===t?n.OnStartedFalling:"onspawnedaseffect"===t?n.OnSpawnedAsEffect:"oncollidedaseffect"===t?n.OnCollidedAsEffect:n.None}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=DataManager.onLoad;DataManager.onLoad=function(e){if(a.call(this,e),e===$dataMapSkillEffectsMap){this.extractMetadata(e);for(var t=e.events,r=0;r<t.length;r++){var i=t[r];i&&void 0!==i.note&&this.extractMetadata(i)}}};var i=(n.padZero=function(e,t){for(var r=e;r.length<t;)r="0"+r;return r},n.init=function(){DataManager.loadDataFile("$dataMapSkillEffectsMap","Map001.json")},n.tempMapSkillEffectDataId=-1,n.tempMapSkillEffectInvokerId=-1,n.pluginCommand=function(e,t){switch(e){case"AMPS-MapSkill":switch(t[0]){case"call":$gameMap.spawnMapSkillEffectEvent(t[1])}}},n);function n(){}t.AMPSManager=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i="LN_AdvancedMapPuzzleSystem";t.paramMapSkillEffectsMapId=Number(PluginManager.parameters(i).MapSkillEffectsMapId),t.paramGuideLineTerrainTag=Number(PluginManager.parameters(i).GuideLineTerrainTag)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var c=r(0),h=r(2),i=(f.isHalfStepX=function(e){return Math.floor(e.x)!==e.x},f.isHalfStepY=function(e){return Math.floor(e.y)!==e.y},f.frontX=function(e,t){return e+(6===t?1:4===t?-1:0)},f.frontY=function(e,t){return e+(2===t?1:8===t?-1:0)},f.frontXAligned=function(e,t){return Math.round(e)+(6===t?1:4===t?-1:0)},f.frontYAligned=function(e,t){return Math.round(e)+(2===t?1:8===t?-1:0)},f.roundXWithDirection=function(e,t){return $gameMap.roundX(e+(6===t?1:4===t?-1:0))},f.roundYWithDirection=function(e,t){return $gameMap.roundY(e+(2===t?1:8===t?-1:0))},f.roundXWithDirectionLong=function(e,t,r){for(var i=f.roundXWithDirection(e,t),a=Math.floor(r),n=0;n<a-1;n++)i=f.roundXWithDirection(i,t);var o=r-Math.floor(r);return 0<o&&(i+=f.roundXWithDirection(0,t)*o),i},f.roundYWithDirectionLong=function(e,t,r){for(var i=f.roundYWithDirection(e,t),a=Math.floor(r),n=0;n<a-1;n++)i=f.roundYWithDirection(i,t);var o=r-Math.floor(r);return 0<o&&(i+=f.roundYWithDirection(0,t)*o),i},f.checkFacingOutsideOnEdgeTile=function(e,t,r){var i=Math.round(e),a=Math.round(t);return!$gameMap.isPassable(i,a,r)},f.checkFacingOtherEdgeTile=function(e,t,r,i){var a=Math.round(f.roundXWithDirectionLong(e,r,i)),n=Math.round(f.roundYWithDirectionLong(t,r,i));return!$gameMap.isPassable(a,n,f.reverseDir(r))},f.canPassJumpGroove=function(e,t,r,i){if(2!=i&&8!=i||!f.isHalfStepX(e))return f.canPassJumpGrooveInternal(e,t,r,i);var a=f.canPassJumpGrooveInternal(e,t-1,r,i),n=f.canPassJumpGrooveInternal(e,t,r,i);return!(!a||!n)&&n},f.canPassJumpGrooveInternal=function(e,t,r,i){var a=Math.round(t),n=Math.round(r),o=Math.round(f.roundXWithDirectionLong(t,i,2)),s=Math.round(f.roundYWithDirectionLong(r,i,2)),c=Math.round(f.roundXWithDirectionLong(t,i,1)),h=Math.round(f.roundYWithDirectionLong(r,i,1)),p=f.roundXWithDirectionLong(t,i,2),u=f.roundYWithDirectionLong(r,i,2);if(!$gameMap.isValid(o,s))return!1;if(!$gameMap.isPassable(a,n,i))return!1;var d=e.reverseDir(i);return!!$gameMap.isPassable(o,s,d)&&!e.isCollidedWithCharacters(p,u)&&!!$gameMap.checkGroove(c,h)},f.checkJumpGroundToGroundInternal=function(e,t,r,i,a){var n=Math.round(t),o=Math.round(r),s=f.roundXWithDirectionLong(t,i,a),c=f.roundYWithDirectionLong(r,i,a),h=Math.round(s),p=Math.round(c);if(!$gameMap.isValid(h,p))return{pass:!1,x:0,y:0};var u=e.reverseDir(i);if($gameMap.isPassable(n,o,i)||$gameMap.isPassable(h,p,u))return{pass:!1,x:0,y:0};if($gameMap.checkNotPassageAll(h,p))return{pass:!1,x:0,y:0};if(e.isCollidedWithCharacters(s,c))return{pass:!1,x:0,y:0};var d=f.roundXWithDirectionLong(t,i,1),l=f.roundYWithDirectionLong(r,i,1);return f.isCollidedWithRiddingEvents(d,l)?{pass:!1,x:0,y:0}:{pass:!0,x:s,y:c}},f.checkMoveOrJumpGroundToObject=function(e,t,r,i,a){var n=Math.round(e),o=Math.round(t),s=Math.round(f.roundXWithDirectionLong(e,r,i)),c=Math.round(f.roundYWithDirectionLong(t,r,i));if(a||!$gameMap.isPassable(n,o,r)){var h=f.findPassableRideObject(s,c);return h||void 0}},f.checkMoveOrJumpObjectToGround=function(e,t,r,i,a){var n=Math.round(f.roundXWithDirectionLong(t,i,a)),o=Math.round(f.roundYWithDirectionLong(r,i,a));if(e.objectType()==c.ObjectType.Box&&!e.isFalling()&&$gameMap.terrainTag(n,o)!=h.paramGuideLineTerrainTag)return!1;var s=e.reverseDir(i);return!$gameMap.isPassable(n,o,s)&&!$gameMap.checkNotPassageAll(n,o)&&!e.isCollidedWithCharacters(n,o)},f.checkMoveOrJumpObjectToObject=function(e,t,r,i){var a=Math.round(f.roundXWithDirectionLong(e,r,i)),n=Math.round(f.roundYWithDirectionLong(t,r,i)),o=f.findPassableRideObject(a,n);if(o)return o},f.isCollidedWithRiddingEvents=function(e,t){return $gameMap.eventsXyNt(e,t).some(function(e){return e.isRidding()})},f.findPassableRideObject=function(e,t){for(var r=$gameMap.events(),i=0;i<r.length;i++)if(r[i].checkPassRide(e,t))return r[i]},f.getCharacterById=function(e){return 0==e?$gamePlayer:$gameMap.events()[e-1]},f.findReactorMapObjectInLineRange=function(e,t,r,i,a){var n=a.toLocaleLowerCase(),o=0;$gameMap.isPassable(e,t,r)||o--;for(var s=0;s<i;s++){var c=Math.round(f.roundXWithDirectionLong(e,r,s+1)),h=Math.round(f.roundYWithDirectionLong(t,r,s+1)),p=this.reverseDir(r);if($gameMap.isPassable(c,h,p)||o++,0===o)for(var u=$gameMap.eventsXyNt(c,h),d=0;d<u.length;d++){var l=u[d];if(l.isMapObject()&&l.reactionMapSkill()==n)return l}if($gameMap.isValid(c,h-1)&&f.checkLayeredTilesFlags($gameMap,c,h-1,16))return;if($gameMap.eventsXyNt(c,h).some(function(e){return 1<=e.objectHeight()}))return;$gameMap.isPassable(c,h,r)||o--}},f.canPassJumpGroundToGround=function(e,t,r,i){if(Math.round(t),Math.round(r),Math.round(f.roundXWithDirectionLong(t,i,2)),Math.round(f.roundYWithDirectionLong(r,i,2)),2==i||8==i){var a=2-(r-Math.floor(r));if(f.isHalfStepX(e)){var n=f.checkJumpGroundToGroundInternal(e,t-1,r,i,a),o=f.checkJumpGroundToGroundInternal(e,t,r,i,a);return!(!n.pass||!o.pass)&&o.pass}return f.checkJumpGroundToGroundInternal(e,t,r,i,a).pass}if(!f.isHalfStepY(e)||4!=i&&6!=i)return f.checkJumpGroundToGroundInternal(e,t,r,i,2).pass;if(!(n=f.checkJumpGroundToGroundInternal(e,t,r,i,2)).pass)return!1;var s=n.x,c=Math.ceil(n.y);return!(e.isCollidedWithCharacters(s,c)&&!(o=f.checkJumpGroundToGroundInternal(e,Math.round(t),c-1,i,2)).pass)&&n.pass},f.findObject=function(e,t){for(var r=$gameMap.eventsXyNt(e,t),i=0;i<r.length;i++)if(r[i].isMapObject())return r[i]},f.checkLayeredTilesFlags=function(e,t,r,i){var a=e.tilesetFlags();return e.layeredTiles(t,r).some(function(e){return 0!==e&&0!=(a[e]&i)})},f.reverseDir=function(e){return 10-e},f.linear=function(e,t,r,i){return r*(e/i)+t},f.easeInExpo=function(e,t,r,i){return r*Math.pow(2,10*(e/i-1))+t},f.distance2D=function(e,t,r,i){var a=r-e,n=i-t;return Math.sqrt(a*a+n*n)},f);function f(){}t.MovingHelper=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i={name:"Evasion1",volume:80,pitch:110,pan:0},a={name:"Earth3",volume:80,pitch:100,pan:0},n=SoundManager.preloadImportantSounds;SoundManager.preloadImportantSounds=function(){n.call(SoundManager),$dataSystem&&AudioManager.loadStaticSe(i)};var o=(s.playGSJump=function(){$dataSystem&&AudioManager.playStaticSe(i)},s.playGSFalled=function(){AudioManager.playSe(a)},s);function s(){}t.AMPS_SoundManager=o},function(e,t,r){"use strict";var i,a=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0});var o=r(3),n=r(0),s=(c.prototype.attachMovingBehavior=function(e,t){this._ownerCharacterId=e.objectId(),this._targetCharacterId=t.objectId(),e._movingBehavior=this,t._movingBehaviorOwnerCharacterId=this._ownerCharacterId},c.prototype.detach=function(){this.ownerCharacter()._movingBehavior=void 0,this.targetCharacter()._movingBehaviorOwnerCharacterId=-1,this._ownerCharacterId=-1,this._targetCharacterId=-1},c.prototype.ownerCharacter=function(){return o.MovingHelper.getCharacterById(this._ownerCharacterId)},c.prototype.targetCharacter=function(){return o.MovingHelper.getCharacterById(this._targetCharacterId)},c.prototype.onOwnerUpdate=function(e){return!1},c.prototype.onOwnerStepEnding=function(e){},c.prototype.onTargetUpdate=function(e){return!1},c.prototype.onTargetStepEnding=function(e){},c);function c(){this._ownerCharacterId=-1,this._targetCharacterId=-1}t.MovingBehavior=s;var h,p=(a(u,h=s),u.checkPushable=function(e){return e.objectType()==n.ObjectType.Box&&!e.rider()},u.tryStartPushObjectAndMove=function(e,t){if(!e.isMover())return!1;var r=o.MovingHelper.roundXWithDirectionLong(e._x,t,1),i=o.MovingHelper.roundYWithDirectionLong(e._y,t,1),a=o.MovingHelper.findObject(r,i);if(!a)return!1;if(!this.checkPushable(a))return!1;if(a.isRidding()){if(!e.isRidding()&&!o.MovingHelper.checkFacingOutsideOnEdgeTile(e._x,e._y,t))return!1}else if(e.isRidding()&&!o.MovingHelper.checkFacingOutsideOnEdgeTile(a._x,a._y,e.reverseDir(t)))return!1;if(this.tryMoveAsPushableObject(a,t)){var n=new u;if(n._ownerOrignalMovingSpeed=e.moveSpeed(),e.setMoveSpeed(a.moveSpeed()),e._forcePositionAdjustment=!0,e.moveStraightMain(t),e._forcePositionAdjustment=!1,e.isMovementSucceeded(e.x,e.y))return n.attachMovingBehavior(e,a),!0}return!1},u.tryMoveAsPushableObject=function(e,t){return!!(e.attemptMoveGroundToGround(t)||e.attemptMoveGroundToObject(t,!1)||e.attemptMoveObjectToObject(t)||e.attemptMoveObjectToGround(t))},u.prototype.onOwnerUpdate=function(e){return!1},u.prototype.onOwnerStepEnding=function(e){e.setMoveSpeed(this._ownerOrignalMovingSpeed)},u.prototype.onTargetStepEnding=function(e){e.isFalling()||this.detach()},u);function u(){var e=h.call(this)||this;return e._ownerOrignalMovingSpeed=0,e}t.MovingBehavior_PushMoving=p},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),r(2),r(1),r(4),r(5),r(7),r(8),r(9),r(10),r(11),r(12),r(13)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o,i,a,n,s=r(0),c=r(3),h=r(4),p=r(5);(i=o=o||{})[i.Stopping=0]="Stopping",i[i.GroundToGround=1]="GroundToGround",i[i.GroundToObject=2]="GroundToObject",i[i.ObjectToObject=3]="ObjectToObject",i[i.ObjectToGround=4]="ObjectToGround",(n=a=a||{})[n.None=0]="None",n[n.Failling=1]="Failling",n[n.EpilogueToRide=2]="EpilogueToRide";var u=Game_CharacterBase.prototype.initMembers;Game_CharacterBase.prototype.initMembers=function(){u.call(this),this._objectType=s.ObjectType.Character,this._ridderCharacterId=-1,this._riddeeCharacterId=-1,this._waitAfterJump=0,this._extraJumping=!1,this._ridingScreenZPriority=-1,this._movingMode=o.Stopping,this._forcePositionAdjustment=!1,this._moveToFalling=!1,this._fallingState=a.None,this._movingBehavior=void 0,this._movingBehaviorOwnerCharacterId=-1,this._getonoffFrameCount=0,this._getonoffFrameMax=0,this._getonoffStartX=0,this._getonoffStartY=0};var d=Game_CharacterBase.prototype.moveStraight;Game_CharacterBase.prototype.moveStraight=function(e){s.assert(2==e||4==e||6==e||8==e),0<this._waitAfterJump?this._waitAfterJump--:p.MovingBehavior_PushMoving.tryStartPushObjectAndMove(this,e)||this.moveStraightMain(e)};var l=Game_CharacterBase.prototype.moveDiagonally;Game_CharacterBase.prototype.moveDiagonally=function(e,t){this.isRidding()||l.call(this,e,t)},Game_CharacterBase.prototype.isRidding=function(){return 0<=this._riddeeCharacterId},Game_CharacterBase.prototype.isMapObject=function(){return!1},Game_Event.prototype.objectType=function(){return this._objectType},Game_CharacterBase.prototype.objectId=function(){return-1},Game_CharacterBase.prototype.objectType=function(){return this._objectType},Game_CharacterBase.prototype.objectHeight=function(){return-1},Game_CharacterBase.prototype.isMover=function(){return this.objectType()==s.ObjectType.Character},Game_CharacterBase.prototype.canRide=function(){return 0<=this.objectHeight()},Game_CharacterBase.prototype.checkPassRide=function(e,t){if(this.canRide()&&!this.rider()){var r=Math.round(this._x),i=Math.round(this._y)-this.objectHeight();if(e==r&&t==i)return!0}return!1},Game_CharacterBase.prototype.rider=function(){return this._ridderCharacterId<0?void 0:0==this._ridderCharacterId?$gamePlayer:$gameMap.event(this._ridderCharacterId)},Game_CharacterBase.prototype.riddingObject=function(){return this._riddeeCharacterId<0?void 0:0==this._riddeeCharacterId?$gamePlayer:$gameMap.event(this._riddeeCharacterId)},Game_CharacterBase.prototype.isFalling=function(){return this._fallingState!=a.None};var f=Game_CharacterBase.prototype.screenZ;Game_CharacterBase.prototype.screenZ=function(){var e=f.call(this),t=this.riddingObject();return this.isRidding()&&t&&(e+=t.screenZ()),0<=this._ridingScreenZPriority&&(e=this._ridingScreenZPriority),e+(this._extraJumping?6:0)},Game_CharacterBase.prototype.moveStraightMain=function(e){this.setMovementSuccess(!1),this.isRidding()?(this.attemptMoveObjectToGround(e)||this.attemptMoveObjectToObject(e)||this.attemptJumpObjectToGround(e)||this.attemptJumpObjectToObject(e),this.setDirection(e)):this.attemptMoveGroundToGround(e)||this.attemptJumpGroundToGround(e)||this.attemptJumpGroove(e)||this.attemptMoveGroundToObject(e,!1)||this.attemptJumpGroundToObject(e)},Game_CharacterBase.prototype.attemptMoveGroundToGround=function(e){var t=this._x,r=this._y;return d.call(this,e),!!this._movementSuccess&&(this._forcePositionAdjustment&&(this._x=Math.round(c.MovingHelper.roundXWithDirection(t,e)),this._y=Math.round(c.MovingHelper.roundYWithDirection(r,e))),this._movingMode=o.GroundToGround,!0)},Game_CharacterBase.prototype.attemptJumpGroundToGround=function(e){return!!c.MovingHelper.canPassJumpGroundToGround(this,this._x,this._y,e)&&(this.setMovementSuccess(!0),this.jumpToDir(e,2,!1),this._movingMode=o.GroundToGround,!0)},Game_CharacterBase.prototype.attemptJumpGroove=function(e){return!!c.MovingHelper.canPassJumpGroove(this,this._x,this._y,e)&&(this.setMovementSuccess(!0),this.jumpToDir(e,2,!1),this._movingMode=o.GroundToGround,!0)},Game_CharacterBase.prototype.attemptMoveGroundToObject=function(e,t){var r=c.MovingHelper.checkMoveOrJumpGroundToObject(this._x,this._y,e,1,t);return!!r&&(this.setMovementSuccess(!0),this.resetGetOnOffParams(),this.moveToDir(e,!0),this.rideToObject(r),this._movingMode=o.GroundToObject,!0)},Game_CharacterBase.prototype.attemptJumpGroundToObject=function(e){var t=c.MovingHelper.checkMoveOrJumpGroundToObject(this._x,this._y,e,2,!1);return!!t&&(this.setMovementSuccess(!0),this.resetGetOnOffParams(),this.jumpToDir(e,2,!0),this.rideToObject(t),this._movingMode=o.GroundToObject,!0)},Game_CharacterBase.prototype.attemptMoveObjectToGround=function(e){return s.assert(this.isRidding()),!!c.MovingHelper.checkMoveOrJumpObjectToGround(this,this._x,this._y,e,1)&&(this.setMovementSuccess(!0),this.resetGetOnOffParams(),this.moveToDir(e,!1),this.unrideFromObject(),this._movingMode=o.ObjectToGround,!0)},Game_CharacterBase.prototype.attemptMoveObjectToObject=function(e){s.assert(this.isRidding());var t=c.MovingHelper.checkMoveOrJumpObjectToObject(this._x,this._y,e,1);return!(!t||t==this)&&(this.setMovementSuccess(!0),this.resetGetOnOffParams(),this.moveToDir(e,!1),this.unrideFromObject(),this.rideToObject(t),this._movingMode=o.ObjectToObject,!0)},Game_CharacterBase.prototype.attemptJumpObjectToGround=function(e){return!!c.MovingHelper.checkMoveOrJumpObjectToGround(this,this._x,this._y,e,2)&&(this.setMovementSuccess(!0),this.jumpToDir(e,2,!1),this.unrideFromObject(),this._movingMode=o.ObjectToGround,!0)},Game_CharacterBase.prototype.attemptJumpObjectToObject=function(e){var t=c.MovingHelper.checkMoveOrJumpObjectToObject(this._x,this._y,e,2);return!!t&&(this.setMovementSuccess(!0),this.resetGetOnOffParams(),this.jumpToDir(e,2,!0),this.unrideFromObject(),this.rideToObject(t),this._movingMode=o.ObjectToObject,!0)},Game_CharacterBase.prototype.rideToObject=function(e){s.assert(!this.isRidding()),s.assert(0<=this.objectId()),s.assert(0<=e.objectId()),this._riddeeCharacterId=e.objectId(),e._ridderCharacterId=this.objectId();var t=this._ridingScreenZPriority;this._ridingScreenZPriority=-1,this._ridingScreenZPriority=this.screenZ(),this._ridingScreenZPriority=Math.max(this._ridingScreenZPriority,t)},Game_CharacterBase.prototype.unrideFromObject=function(){s.assert(this.isRidding());var e=this.riddingObject();e&&(e._ridderCharacterId=-1),this._riddeeCharacterId=-1},Game_CharacterBase.prototype.moveToDir=function(e,t){this._x=$gameMap.roundXWithDirection(this._x,e),this._y=$gameMap.roundYWithDirection(this._y,e),this._realX=$gameMap.xWithDirection(this._x,this.reverseDir(e)),this._realY=$gameMap.yWithDirection(this._y,this.reverseDir(e)),(t||this._forcePositionAdjustment)&&(this._y=Math.round(this._y)),this._forcePositionAdjustment&&(this._x=Math.round(this._x))},Game_CharacterBase.prototype.jumpToDir=function(e,t,r){var i=this._x,a=this._y;r||(i=Math.round(this._x),2==e||8==e||(a=Math.round(this._y)));var n=Math.round(c.MovingHelper.roundXWithDirectionLong(this._x,e,t)),o=Math.round(c.MovingHelper.roundYWithDirectionLong(this._y,e,t));this.jump(n-i,o-a),this._waitAfterJump=10,this._extraJumping=!0,h.AMPS_SoundManager.playGSJump()},Game_CharacterBase.prototype.startFall=function(){console.log("not implemented.")};var v=Game_CharacterBase.prototype.isMoving;Game_CharacterBase.prototype.isMoving=function(){return(!this.isRidding()||this._movingMode!=o.Stopping)&&v.call(this)};var m=Game_CharacterBase.prototype.update;Game_CharacterBase.prototype.update=function(){if(!this._movingBehavior||!this._movingBehavior.onOwnerUpdate(this)){if(0<=this._movingBehaviorOwnerCharacterId){var e=c.MovingHelper.getCharacterById(this._movingBehaviorOwnerCharacterId);if(e._movingBehavior&&e._movingBehavior.onTargetUpdate(this))return}var t;m.call(this),this.isFalling()&&console.log("not implemented."),!this.isRidding()||this._movingMode!=o.Stopping||(t=this.riddingObject())&&(this._x=t._x,this._y=t._y-t.objectHeight(),this._realX=t._realX,this._realY=t._realY-t.objectHeight())}};var g=Game_CharacterBase.prototype.updateStop;Game_CharacterBase.prototype.updateStop=function(){g.call(this),this.isRidding()||(this._ridingScreenZPriority=-1),this._movingMode=o.Stopping};var _=Game_CharacterBase.prototype.updateMove;Game_CharacterBase.prototype.updateMove=function(){var e,t,r,i,a=this.isMoving();this.isMoving()&&this._movingMode!=o.Stopping&&this._movingMode!=o.GroundToGround?(this._getonoffFrameCount++,t=e=0,this._movingMode==o.GroundToObject||this._movingMode==o.ObjectToObject?(r=this.riddingObject())&&(e=r._realX,t=r._realY-r.objectHeight()):this._movingMode==o.ObjectToGround&&(e=this._x,t=this._y),i=Math.min(this._getonoffFrameCount/this._getonoffFrameMax,1),this._realX=c.MovingHelper.linear(i,this._getonoffStartX,e-this._getonoffStartX,1),this._realY=c.MovingHelper.linear(i,this._getonoffStartY,t-this._getonoffStartY,1),this._getonoffFrameCount>=this._getonoffFrameMax&&(this._movingMode=o.Stopping)):_.call(this),a==this.isMoving()||this.isMoving()||(this._moveToFalling?(this._moveToFalling=!1,this.startFall()):this.onStepEnd())};var M=Game_CharacterBase.prototype.updateJump;Game_CharacterBase.prototype.updateJump=function(){var e,t,r,i,a,n=this.isJumping();M.call(this),this.isRidding()&&n&&(this._movingMode!=o.GroundToObject&&this._movingMode!=o.ObjectToObject||(e=this.riddingObject())&&(t=e._realX,r=e._realY-e.objectHeight(),i=2*this._jumpPeak,a=Math.min((i-this._jumpCount+1)/i,1),this._realX=c.MovingHelper.linear(a,this._getonoffStartX,t-this._getonoffStartX,1),this._realY=c.MovingHelper.linear(a,this._getonoffStartY,r-this._getonoffStartY,1),this._x=e._x,this._y=e._y-e.objectHeight())),this.isJumping()||(this._extraJumping=!1,this._movingMode=o.Stopping,n!=this.isJumping()&&this.onJumpEnd())},Game_CharacterBase.prototype.resetGetOnOffParams=function(){this._getonoffFrameMax=1/this.distancePerFrame(),this._getonoffFrameCount=0,this._getonoffStartX=this._realX,this._getonoffStartY=this._realY},Game_CharacterBase.prototype.onStepEnd=function(){var e;this._movingBehavior&&this._movingBehavior.onOwnerStepEnding(this),0<=this._movingBehaviorOwnerCharacterId&&((e=c.MovingHelper.getCharacterById(this._movingBehaviorOwnerCharacterId))._movingBehavior&&e._movingBehavior.onTargetStepEnding(this));var t=this.riddingObject();t&&t.onCharacterRideOn()},Game_CharacterBase.prototype.onJumpEnd=function(){var e=this.riddingObject();e&&e.onCharacterRideOn()},Game_CharacterBase.prototype.onCharacterRideOn=function(){};var y=Game_CharacterBase.prototype.isHalfMove;Game_CharacterBase.prototype.isHalfMove=function(){return!!this.isMover()&&(!this._forcePositionAdjustment&&(!!y&&y.call(this)))}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Game_Player.prototype.objectId=function(){return 0};var i=Game_Player.prototype.isCollided;Game_Player.prototype.isCollided=function(e,t){return!this.isRidding()&&i.call(this,e,t)};var a=Game_Player.prototype.canMove;Game_Player.prototype.canMove=function(){return!this._movingBehavior&&a.call(this)};var n=Game_Player.prototype.isDashing;Game_Player.prototype.isDashing=function(){return!this._movingBehavior&&n.call(this)}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s,i,a=r(2),c=r(0),n=r(1),o=r(3);(i=s=s||{})[i.Default=0]="Default",i[i.Front=1]="Front";var h=Game_Event.prototype.initMembers;Game_Event.prototype.initMembers=function(){h.call(this),this._objectType=c.ObjectType.Character,this._objectHeight=-1,this._fallable=!1,this._mapObjectEventTrigger=c.EventTrigger.None,this._mapSkillEffectDataId=n.AMPSManager.tempMapSkillEffectDataId,this._mapSkillEffectInvokerId=n.AMPSManager.tempMapSkillEffectInvokerId,this._mapSkillEffectInitialPosition=s.Default};var p=Game_Event.prototype.event;Game_Event.prototype.event=function(){return $dataMapSkillEffectsMap.events&&this._mapId===a.paramMapSkillEffectsMapId?(c.assert(0<=this._mapSkillEffectDataId),$dataMapSkillEffectsMap.events[this._mapSkillEffectDataId]):p.call(this)},Game_Event.prototype.isMapObject=function(){return this._objectType!=c.ObjectType.Character},Game_Event.prototype.objectId=function(){return this.eventId()},Game_Event.prototype.objectHeight=function(){return this._objectHeight},Game_Event.prototype.reactionMapSkill=function(){return this._reactionMapSkill},Game_Event.prototype.mapSkillEffectInvoker=function(){return this._mapSkillEffectInvokerId<0?void 0:0==this._mapSkillEffectInvokerId?$gamePlayer:$gameMap.event(this._mapSkillEffectInvokerId)},Game_Event.prototype.directionAsMapSkillEffect=function(){var e=this.mapSkillEffectInvoker();return e?e.direction():this.direction()};var u=Game_Event.prototype.refresh;Game_Event.prototype.refresh=function(){u.call(this);var e=this.mapSkillEffectInvoker();e&&((this._mapSkillEffectInitialPosition=s.Front)?this.locate(o.MovingHelper.frontX(e.x,e.direction()),o.MovingHelper.frontY(e.y,e.direction())):this.locate(e.x,e.y))};var d=Game_Event.prototype.setupPage;Game_Event.prototype.setupPage=function(){var e,t,r,i=this.objectHeight(),a=this.rider();d.call(this),this.parseListCommentForAMPSObject(),0==this.objectHeight()&&a&&a.jump(0,i),this._objectType==c.ObjectType.Effect&&this._mapObjectEventTrigger==c.EventTrigger.OnSpawnedAsEffect&&(!(t=this.mapSkillEffectInvoker())||(r=o.MovingHelper.findReactorMapObjectInLineRange(t.x,t.y,this.directionAsMapSkillEffect(),this._mapSkillRange,null!==(e=this.event().name)&&void 0!==e?e:""))&&r.startAsReactor())},Game_Event.prototype.parseListCommentForAMPSObject=function(){this._objectType=c.ObjectType.Character,this._objectHeight=-1,this._fallable=!1,this._mapObjectEventTrigger=c.EventTrigger.None,this._mapSkillRange=-1,this._reactionMapSkill="",this._mapSkillEffectInitialPosition=s.Default;var e=this.list();if(e){for(var t="",r=0;r<e.length;r++)108!=e[r].code&&408!=e[r].code||e[r].parameters&&(t+=e[r].parameters);var i=t.indexOf("@MapObject");if(0<=i){for(var a=t.substring(i+6),n=(a=a.substring(a.indexOf("{")+1,a.indexOf("}"))).split(","),r=0;r<n.length;r++){var o=n[r].split(":");switch(o[0].trim()){case"type":this._objectType=c.strToObjectType(o[1].trim());break;case"h":case"height":this._objectHeight=Number(o[1].trim());break;case"fallable":this._fallable="true"==o[1].trim();break;case"trigger":this._mapObjectEventTrigger=c.strToEventTrigger(o[1].trim());break;case"range":this._mapSkillRange=Number(o[1].trim());break;case"reaction":this._reactionMapSkill=o[1].trim().toLocaleLowerCase();break;case"pos":switch(o[1].trim().toLocaleLowerCase()){case"front":this._mapSkillEffectInitialPosition=s.Front}}}return!0}}return!1};var l=Game_Event.prototype.start;Game_Event.prototype.start=function(){this.objectType()==c.ObjectType.Reactor||l.call(this)},Game_Event.prototype.startAsReactor=function(){l.call(this)};var f=Game_Event.prototype.updateParallel;Game_Event.prototype.updateParallel=function(){var e;this._interpreter?(e=this._interpreter.isRunning(),f.call(this),e&&!this._interpreter.isRunning()&&this.onTerminateParallelEvent()):f.call(this)},Game_Event.prototype.onTerminateParallelEvent=function(){this._mapId===a.paramMapSkillEffectsMapId&&$gameMap.despawnMapSkillEffectEvent(this)}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(2),n=r(1),i=r(0);Game_Map.prototype.checkPassage=function(e,t,r){for(var i=this.tilesetFlags(),a=this.allTiles(e,t),n=0;n<a.length;n++){var o=i[a[n]];if(i[a[n]]>>12!=s.paramGuideLineTerrainTag&&0==(16&o)){if(0==(o&r))return!0;if((o&r)===r)return!1}}return!1},Game_Map.prototype.checkNotPassageAll=function(e,t){for(var r=this.tilesetFlags(),i=this.allTiles(e,t),a=0,n=0;n<i.length;n++){a|=r[i[n]]}return 15==(15&a)},Game_Map.prototype.checkGroove=function(e,t){for(var r=this.allTiles(e,t),i=0;i<r.length;i++)if(Tilemap.isTileA1(r[i]))return!0;return!1},Game_Map.prototype.spawnMapSkillEffectEvent=function(e){if(console.log($dataMapSkillEffectsMap),$dataMapSkillEffectsMap.events){for(var t=-1,r=0;r<$dataMapSkillEffectsMap.events.length;r++)if($dataMapSkillEffectsMap.events[r]&&$dataMapSkillEffectsMap.events[r].name==e){t=r;break}if(0<=t){n.AMPSManager.tempMapSkillEffectDataId=t,n.AMPSManager.tempMapSkillEffectInvokerId=0;var i=this._events.length,a=new Game_Event(s.paramMapSkillEffectsMapId,i);return n.AMPSManager.tempMapSkillEffectDataId=-1,n.AMPSManager.tempMapSkillEffectInvokerId=-1,a._eventIndex=i,this._events[i]=a,this._spawnMapSkillEffectEventcallback&&this._spawnMapSkillEffectEventcallback(a),a}}},Game_Map.prototype.despawnMapSkillEffectEvent=function(e){i.assert(0<=e._eventIndex),this._events.splice(e._eventIndex,1),this._despawnMapSkillEffectEventcallback&&this._despawnMapSkillEffectEventcallback(e)},Game_Map.prototype.setSpawnMapSkillEffectEventHandler=function(e){this._spawnMapSkillEffectEventcallback=e},Game_Map.prototype.setDespawnMapSkillEffectEventHandler=function(e){this._despawnMapSkillEffectEventcallback=e}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=r(1),a=Game_Interpreter.prototype.pluginCommand;Game_Interpreter.prototype.pluginCommand=function(e,t){a.call(this,e,t),i.AMPSManager.pluginCommand(e,t)}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=r(0),a=Spriteset_Map.prototype.createCharacters;Spriteset_Map.prototype.createCharacters=function(){a.call(this),$gameMap.setSpawnMapSkillEffectEventHandler(this.onSpawnMapSkillEffectEvent.bind(this)),$gameMap.setDespawnMapSkillEffectEventHandler(this.onDespawnMapSkillEffectEvent.bind(this))},Spriteset_Map.prototype.onSpawnMapSkillEffectEvent=function(e){i.assert(null!=e._eventIndex);var t=new Sprite_Character(e);this._characterSprites.push(t),this._tilemap.addChild(t)},Spriteset_Map.prototype.onDespawnMapSkillEffectEvent=function(e){i.assert(null!=e._eventIndex);for(var t=0;t<this._characterSprites.length;t++){var r=this._characterSprites[t]._character;if(r&&null!=r._eventIndex&&r._eventIndex==e._eventIndex){this._tilemap.removeChild(this._characterSprites[t]),this._characterSprites.splice(t,1);break}}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=r(1),a=Scene_Boot.prototype.create;Scene_Boot.prototype.create=function(){a.call(this),i.AMPSManager.init()}}]);